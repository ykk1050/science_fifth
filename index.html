<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¼ìŠ¤íŠ¸ ë…¸ë°”: ì¸ë¥˜ì˜ ë§ˆì§€ë§‰ ë¹›</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #2c3e50;
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            touch-action: none;
        }
        canvas {
            display: block;
            margin: 0 auto;
            background-color: #95a5a6;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        /* UI ë ˆì´ì–´ */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        /* ê³µí†µ íŒì—… ìŠ¤íƒ€ì¼ */
        .popup {
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            color: white;
            pointer-events: auto;
            border: 2px solid #3498db;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        h1 { margin: 0 0 20px 0; color: #3498db; text-shadow: 2px 2px 0 #000; font-size: 2rem; }
        h2 { color: #f1c40f; margin-bottom: 15px; }
        p { font-size: 1.1rem; line-height: 1.5; margin: 10px 0; }
        
        /* ì…ë ¥ í•„ë“œ */
        input[type="text"] {
            padding: 10px;
            font-size: 1.2rem;
            border-radius: 5px;
            border: none;
            width: 70%;
            text-align: center;
            margin-bottom: 15px;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px 5px;
            transition: transform 0.1s, background 0.2s;
            font-weight: bold;
            font-family: inherit;
        }
        button:hover { transform: scale(1.05); background: #c0392b; }
        button:active { transform: scale(0.95); }
        button.secondary { background: #34495e; border: 1px solid #7f8c8d; }
        button.secondary:hover { background: #2c3e50; }
        button.green { background: #27ae60; }
        button.green:hover { background: #219150; }

        .hidden { display: none !important; }

        /* ê¸°ë¡ í…Œì´ë¸” */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 8px; border-bottom: 1px solid #555; }
        th { color: #3498db; }
        tr:nth-child(1) td { color: #f1c40f; font-weight: bold; } /* 1ë“± ê°•ì¡° */

        /* HUD (ê²Œì„ ì¤‘ ìƒë‹¨ í‘œì‹œ) */
        #hud {
            position: absolute;
            top: 90px; /* ìƒë‹¨ ë¬¸ì œ í‘œì‹œì¤„ ì•„ë˜ */
            right: 10px;
            text-align: right;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            pointer-events: none;
            font-size: 1.0rem;
        }
        .stat-item { margin-bottom: 5px; }
        .combo-text { color: #f1c40f; font-size: 1.2rem; transition: transform 0.1s; }
        .combo-active { transform: scale(1.2); }
        
        /* ì¶”ê°€ëœ í†µê³„ ìŠ¤íƒ€ì¼ */
        .hud-section {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.3);
            font-size: 0.8rem;
            color: #bdc3c7;
        }
        .hud-title {
            color: #f39c12;
            font-size: 0.9rem;
            margin-bottom: 3px;
        }

        /* ë­í‚¹ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .rank-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        .rank-table th { background: #2c3e50; color: #3498db; padding: 10px; position: sticky; top: 0; }
        .rank-table td { border-bottom: 1px solid #555; padding: 8px; text-align: center; }
        .rank-table tr:nth-child(1) td { color: #f1c40f; font-weight: bold; font-size: 1.1rem; } /* 1ë“± */
        .rank-table tr:nth-child(2) td { color: #bdc3c7; font-weight: bold; } /* 2ë“± */
        .rank-table tr:nth-child(3) td { color: #e67e22; font-weight: bold; } /* 3ë“± */
        
        .loading-text { color: #bdc3c7; margin: 20px; font-style: italic; }

        /* ë­í‚¹ íƒ­ ìŠ¤íƒ€ì¼ */
        .rank-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
            gap: 5px;
        }
        .rank-tab {
            background: #34495e;
            border: 1px solid #7f8c8d;
            color: #bdc3c7;
            padding: 8px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 5px;
            flex: 1;
        }
        .rank-tab.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
            font-weight: bold;
        }
        .my-rank-row {
            background-color: rgba(52, 152, 219, 0.2);
            border: 2px solid #3498db !important;
        }

        /* ì‹œì‘ í™”ë©´ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
        #start-screen {
            background: url('background (2).png') no-repeat center center;
            background-size: cover;
            padding: 40px;
            width: 500px;
            border: 2px solid #ecf0f1;
        }

        .start-content-box {
            /* ë°°ê²½ ì œê±° */
            background: none;
            padding: 10px;
        }

        #start-screen h1 {
            color: #c0392b; /* ë¶‰ì€ìƒ‰ ì œëª© */
            /* í°ìƒ‰ í…Œë‘ë¦¬ íš¨ê³¼ (ê°€ë…ì„± í™•ë³´) */
            text-shadow: 
                -2px -2px 0 #fff,  
                 2px -2px 0 #fff,
                -2px  2px 0 #fff,
                 2px  2px 0 #fff;
            margin-bottom: 15px;
        }

        #start-screen p {
            color: #2c3e50; /* ì§™ì€ ë‚¨ìƒ‰ í…ìŠ¤íŠ¸ */
            font-weight: bold;
            /* í°ìƒ‰ í…Œë‘ë¦¬/í›„ê´‘ íš¨ê³¼ */
            text-shadow: 
                -1px -1px 0 #fff,  
                 1px -1px 0 #fff,
                -1px  1px 0 #fff,
                 1px  1px 0 #fff,
                 0 0 10px #fff;
            margin-bottom: 20px;
        }

        /* ì‹œì‘ í™”ë©´ ë‚´ë¶€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¡°ì • */
        #start-screen button {
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            border: 2px solid white; /* ë²„íŠ¼ì´ ì˜ ë³´ì´ë„ë¡ í…Œë‘ë¦¬ ì¶”ê°€ */
        }
        
        #start-screen input[type="text"] {
            border: 2px solid #3498db;
            background: rgba(255, 255, 255, 0.9); /* ì…ë ¥ì°½ì€ ì˜ ë³´ì—¬ì•¼ í•˜ë¯€ë¡œ ë°°ê²½ ìœ ì§€ */
            color: #2c3e50;
            font-weight: bold;
        }

        /* BGM ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #bgm-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 20;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid white;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        #bgm-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .version-text {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: #95a5a6; /* íšŒìƒ‰ */
            font-size: 0.8rem;
            z-index: 100;
            pointer-events: none;
            font-family: sans-serif;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    
    <!-- BGM ì˜¤ë””ì˜¤ íƒœê·¸ (ë£¨í”„ ì¬ìƒ) -->
    <audio id="bgm-audio" loop>
        <source src="cinematic-epic-music-459422.mp3" type="audio/mp3">
    </audio>
    
    <!-- íš¨ê³¼ìŒ ì˜¤ë””ì˜¤ íƒœê·¸ -->
    <audio id="sfx-correct">
        <source src="bonus-points-190035.mp3" type="audio/mp3">
    </audio>
    <audio id="sfx-wrong">
        <source src="error-010-206498.mp3" type="audio/mp3">
    </audio>
    <audio id="sfx-bomb">
        <source src="nuclear-explosion-386181.mp3" type="audio/mp3">
    </audio>

    <!-- BGM í† ê¸€ ë²„íŠ¼ -->
    <button id="bgm-btn" onclick="toggleSound()">ğŸµ ì†Œë¦¬: OFF</button>
    
    <!-- ë²„ì „ ì •ë³´ -->
    <div class="version-text">ë¼ìŠ¤íŠ¸ ë…¸ë°”: ì¸ë¥˜ì˜ ë§ˆì§€ë§‰ ë¹› made by gamtudyssam 0.0012</div>

    <canvas id="gameCanvas"></canvas>

    <!-- HUD -->
    <div id="hud" class="hidden">
        <!-- í˜„ì¬ ê²Œì„ -->
        <div class="stat-item">ì ìˆ˜: <span id="hud-score">0</span></div>
        <div class="stat-item">ì •ë‹µ: <span id="hud-total">0</span></div>
        <div class="stat-item combo-text" id="hud-combo">Combo: 0</div>
        
        <!-- ìµœê³  ê¸°ë¡ (Best) -->
        <div class="hud-section">
            <div class="hud-title">ğŸ† ìµœê³  ê¸°ë¡</div>
            <div>ì ìˆ˜: <span id="hud-best-score">0</span></div>
            <div>ì½¤ë³´: <span id="hud-best-combo">0</span></div>
            <div>ì •ë‹µ: <span id="hud-best-correct">0</span></div>
        </div>

        <!-- ëˆ„ì  ê¸°ë¡ (Lifetime) -->
        <div class="hud-section">
            <div class="hud-title">ğŸ“Š ëˆ„ì  í†µê³„</div>
            <div>ì´ ì •ë‹µ: <span id="hud-life-correct">0</span></div>
            <div>ì •ë‹µë¥ : <span id="hud-life-acc">0%</span></div>
        </div>
    </div>

    <div id="ui-layer">
        <!-- ì‹œì‘ í™”ë©´ -->
        <div id="start-screen" class="popup">
            <div class="start-content-box">
                <h1>ë¼ìŠ¤íŠ¸ ë…¸ë°”<br><span style="font-size: 0.7em;">: ì¸ë¥˜ì˜ ë§ˆì§€ë§‰ ë¹›</span></h1>
                <p>ë¯¸ì§€ì˜ ì™¸ê³„ì¸ë“¤ì´ ì§€êµ¬ë¥¼ ì‚¼í‚¤ë ¤ í•œë‹¤. ì´ì œ, ì¸ë¥˜ì˜ ë§ˆì§€ë§‰ í¬ë§ì¸ ë‹¹ì‹ ì´ ì™¸ê³„ ë³¸ê±°ì§€ë¡œ í–¥í•œë‹¤. ëª¨ë“  ê²ƒì„ ê±¸ê³  ì‹¸ì›Œ, ì¸ë¥˜ì˜ ìƒˆë²½ì„ ë‹¤ì‹œ ë§ì´í•˜ë¼!</p>
                
                <input type="text" id="nickname-input" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="8">
                
                <div id="resume-area" class="hidden">
                    <p style="color: #e67e22;">ì €ì¥ëœ ê²Œì„ì´ ìˆìŠµë‹ˆë‹¤!</p>
                    <button class="green" onclick="loadGameAndStart()">ì´ì–´í•˜ê¸°</button>
                </div>

                <div>
                    <button onclick="startNewGame()">ìƒˆ ê²Œì„ ì‹œì‘</button>
                    <button class="secondary" onclick="showRecords()"> ë‚˜ì˜ ê¸°ë¡ ë³´ê¸°</button>
                </div>
                <div style="margin-top: 5px;">
                    <button class="green" onclick="showGlobalRankings()">ğŸŒ ì„¸ê³„ì˜ ìœ„ëŒ€í•œ ìš©ì‚¬ë“¤ ëª…ë‹¨</button>
                </div>
            </div>
        </div>

        <!-- ê¸°ë¡ í™”ë©´ -->
        <div id="records-screen" class="popup hidden">
            <h2>ğŸ† ì§€êµ¬ë¥¼ ìœ„í•œ ë‚˜ì˜ ìœ„ëŒ€í•œ ê¸°ë¡</h2>
            <div style="max-height: 200px; overflow-y: auto;">
                <table id="records-table">
                    <thead>
                        <tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ì ìˆ˜</th><th>ì •ë‹µ</th><th>ìµœëŒ€ì½¤ë³´</th></tr>
                    </thead>
                    <tbody><!-- JSë¡œ ì±„ì›€ --></tbody>
                </table>
            </div>
            <button class="secondary" onclick="hideRecords()">ë‹«ê¸°</button>
        </div>

        <!-- ê¸€ë¡œë²Œ ë­í‚¹ í™”ë©´ -->
        <div id="ranking-screen" class="popup hidden">
            <h2>ğŸŒ ì„¸ê³„ì˜ ìœ„ëŒ€í•œ ìš©ì‚¬ë“¤ ëª…ë‹¨</h2>
            
            <!-- ë­í‚¹ íƒ­ -->
            <div class="rank-tabs">
                <button class="rank-tab active" id="tab-bestScore" onclick="loadRankings('bestScore')">ì ìˆ˜</button>
                <button class="rank-tab" id="tab-bestCombo" onclick="loadRankings('bestCombo')">ì½¤ë³´</button>
                <button class="rank-tab" id="tab-lifetimeCorrect" onclick="loadRankings('lifetimeCorrect')">ëˆ„ì ì •ë‹µ</button>
                <button class="rank-tab" id="tab-accuracy" onclick="loadRankings('accuracy')">ì •ë‹µë¥ </button>
            </div>
            
            <div id="rank-info" style="font-size: 0.8rem; color: #bdc3c7; margin: 5px 0;">
                ìƒìœ„ 100ìœ„ê¹Œì§€ í‘œì‹œë©ë‹ˆë‹¤.
            </div>

            <div id="ranking-list" style="max-height: 250px; overflow-y: auto;">
                <p class="loading-text">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            
            <!-- ë‚´ ìˆœìœ„ (100ìœ„ ë°–ì¼ ë•Œ í‘œì‹œ) -->
            <div id="my-rank-section" style="border-top: 1px solid #555; padding-top: 10px; margin-top: 10px; display: none;">
                <div style="color: #f1c40f; font-weight: bold; font-size: 0.9rem; margin-bottom: 5px;">ë‚´ ìˆœìœ„</div>
                <table class="rank-table" style="margin-top: 0;">
                    <tbody id="my-rank-body"></tbody>
                </table>
            </div>

            <button class="secondary" onclick="hideGlobalRankings()">ë‹«ê¸°</button>
        </div>

        <!-- ê²Œì„ ì˜¤ë²„ í™”ë©´ -->
        <div id="game-over-screen" class="popup hidden">
            <h1>ê²Œì„ ì˜¤ë²„</h1>
            <p id="final-msg">ìˆ˜ê³ í–ˆìŠµë‹ˆë‹¤!</p>
            <p id="final-score-text">ì ìˆ˜: 0</p>
            <p id="final-stats-text">ì´ ì •ë‹µ: 0 / ìµœëŒ€ ì½¤ë³´: 0</p>
            <button onclick="returnToMain()">ë©”ì¸ìœ¼ë¡œ</button>
        </div>
    </div>

<script>
/**
 * 1. ì„¤ì • ë° ë¦¬ì†ŒìŠ¤
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let GAME_WIDTH = window.innerWidth > 600 ? 600 : window.innerWidth;
let GAME_HEIGHT = window.innerHeight;
canvas.width = GAME_WIDTH;
canvas.height = GAME_HEIGHT;

const playerImg = new Image();
playerImg.src = 'spaceship.png';
const enemyImg = new Image();
enemyImg.src = 'alien.png';

// ë³´ìŠ¤ ì´ë¯¸ì§€ ë¡œë“œ
const bossImgs = [];
for(let i=1; i<=4; i++) {
    const img = new Image();
    img.src = `boss${i}.png`;
    bossImgs.push(img);
}

// ì•„ì´í…œ ì´ë¯¸ì§€ ë¡œë“œ
const itemImgs = {
    bomb: new Image(),
    fever: new Image()
};
itemImgs.bomb.src = 'bomb.png';
itemImgs.fever.src = 'fever.png';

// ë¬¸ì œ ë°ì´í„° (ì „ì²´ í¬í•¨)
const QUESTIONS = [
    // [ë‚ ì”¨ì™€ ìš°ë¦¬ ìƒí™œ]
    { q: "ìŠµë„ëŠ” ë¬´ì—‡ì„ ì˜ë¯¸í•˜ë‚˜ìš”?", a: "ê³µê¸° ì¤‘ ìˆ˜ì¦ê¸°ì˜ ì–‘", w: ["ê³µê¸°ì˜ ì˜¨ë„", "ë°”ëŒì˜ ì„¸ê¸°"] },
    { q: "ì´ìŠ¬ì´ë‚˜ ì•ˆê°œëŠ” ìˆ˜ì¦ê¸°ê°€ ë¬´ì—‡ì´ ëœ ê²ƒì¸ê°€ìš”?", a: "ë¬¼ë°©ìš¸", w: ["ì–¼ìŒ", "ëˆˆ"] },
    { q: "ë°”ëŒì€ ê³µê¸°ê°€ ì–´ë””ë¡œ ì´ë™í•˜ëŠ” ê²ƒì¸ê°€ìš”?", a: "ê³ ê¸°ì•• â†’ ì €ê¸°ì••", w: ["ì €ê¸°ì•• â†’ ê³ ê¸°ì••", "ê³ ê¸°ì•• â†’ ê³ ê¸°ì••"] },
    { q: "ìš°ë¦¬ë‚˜ë¼ ì—¬ë¦„ì²  ë‚ ì”¨ì— ì˜í–¥ì„ ì£¼ëŠ” ê¸°ë‹¨ì€?", a: "ë¶íƒœí‰ì–‘ (ê³ ì˜¨ë‹¤ìŠµ)", w: ["ì‹œë² ë¦¬ì•„ (í•œë­ê±´ì¡°)", "ì˜¤í˜¸ì¸ í¬í•´ (í•œë­ë‹¤ìŠµ)"] },
    { q: "í•˜ë£¨ ì¤‘ ê¸°ì˜¨ì´ ê°€ì¥ ë†’ì€ ë•ŒëŠ”?", a: "ì˜¤í›„ 2~3ì‹œê²½", w: ["ì •ì˜¤ (12ì‹œ)", "í•´ ì§ˆ ë¬´ë µ"] },
    { q: "ì§€ë©´ì´ ë°ì›Œì ¸ ê³µê¸°ê°€ ìœ„ë¡œ ì˜¬ë¼ê°€ëŠ” í˜„ìƒì€?", a: "ëŒ€ë¥˜ í˜„ìƒ", w: ["ë³µì‚¬ í˜„ìƒ", "ì „ë„ í˜„ìƒ"] },
    { q: "ë¹„ê°€ ë‚´ë¦¬ëŠ” ì–‘ì„ ì¸¡ì •í•˜ëŠ” ê¸°êµ¬ëŠ”?", a: "ìš°ëŸ‰ê³„", w: ["í’í–¥ê³„", "ìŠµë„ê³„"] },
    { q: "ê³µê¸°ì˜ ë¬´ê²Œë¡œ ì¸í•´ ìƒê¸°ëŠ” ì••ë ¥ì€?", a: "ê¸°ì••", w: ["ìˆ˜ì••", "í˜ˆì••"] },
    { q: "ê³µê¸°ì˜ ìŠµë„ë¥¼ ì¸¡ì •í•˜ëŠ” ë„êµ¬ëŠ”?", a: "ê±´ìŠµêµ¬ ì˜¨ë„ê³„", w: ["ì˜¨ë„ê³„", "ê¸°ì••ê³„"] },
    { q: "ê±´êµ¬ì™€ ìŠµêµ¬ ì˜¨ë„ì˜ ì°¨ì´ê°€ ì—†ì„ ë•Œ ìŠµë„ëŠ”?", a: "100%", w: ["0%", "50%"] },
    { q: "ê±´êµ¬ì™€ ìŠµêµ¬ ì˜¨ë„ì˜ ì°¨ì´ê°€ í´ìˆ˜ë¡ ìŠµë„ëŠ” ì–´ë–»ê²Œ ë˜ë‚˜ìš”?", a: "ë‚®ë‹¤ (ê±´ì¡°í•˜ë‹¤)", w: ["ë†’ë‹¤ (ìŠµí•˜ë‹¤)", "ì•Œ ìˆ˜ ì—†ë‹¤"] },
    { q: "ìˆ˜ì¦ê¸°ê°€ ì°¨ê°€ìš´ ë¬¼ì²´ í‘œë©´ì— ë§ºí˜€ ë¬¼ë°©ìš¸ì´ ëœ ê²ƒì€?", a: "ì´ìŠ¬", w: ["ì•ˆê°œ", "êµ¬ë¦„"] },
    { q: "ê³µê¸° ì¤‘ ìˆ˜ì¦ê¸°ê°€ ì‘ê²°í•˜ì—¬ ì§€í‘œë©´ ê·¼ì²˜ì—ì„œ ë¿Œì˜‡ê²Œ ë³´ì´ëŠ” í˜„ìƒì€?", a: "ì•ˆê°œ", w: ["ì´ìŠ¬", "êµ¬ë¦„"] },
    { q: "ê³µê¸° ë©ì–´ë¦¬ê°€ í•˜ëŠ˜ ë†’ì´ ì˜¬ë¼ê°€ ë¬¼ë°©ìš¸ì´ë‚˜ ì–¼ìŒ ì•Œê°±ì´ê°€ ëœ ê²ƒì€?", a: "êµ¬ë¦„", w: ["ì´ìŠ¬", "ì•ˆê°œ"] },
    { q: "ì£¼ë³€ë³´ë‹¤ ê³µê¸°ì˜ ì••ë ¥ì´ ë†’ì€ ê³³ì€?", a: "ê³ ê¸°ì••", w: ["ì €ê¸°ì••", "ë¬´ê¸°ì••"] },
    { q: "ë‚®ì— ë°”ë‹¤ì—ì„œ ìœ¡ì§€ë¡œ ë¶€ëŠ” ë°”ëŒì€?", a: "í•´í’", w: ["ìœ¡í’", "ê³„ì ˆí’"] },
    { q: "ë°¤ì— ìœ¡ì§€ì—ì„œ ë°”ë‹¤ë¡œ ë¶€ëŠ” ë°”ëŒì€?", a: "ìœ¡í’", w: ["í•´í’", "ëŒí’"] },
    { q: "ìš°ë¦¬ë‚˜ë¼ ì—¬ë¦„ì²  ë‚ ì”¨ì— ì˜í–¥ì„ ì£¼ëŠ” ê¸°ë‹¨ì˜ ì„±ì§ˆì€?", a: "ë¥ê³  ìŠµí•˜ë‹¤", w: ["ì°¨ê³  ê±´ì¡°í•˜ë‹¤", "ë”°ëœ»í•˜ê³  ê±´ì¡°í•˜ë‹¤"] },
    { q: "ê²¨ìš¸ì²  ì°¨ê°‘ê³  ê±´ì¡°í•œ ë°”ëŒì„ ë³´ë‚´ëŠ” ê¸°ë‹¨ì€?", a: "ì‹œë² ë¦¬ì•„ ê¸°ë‹¨", w: ["ë¶íƒœí‰ì–‘ ê¸°ë‹¨", "ì˜¤í˜¸ì¸ í¬í•´ ê¸°ë‹¨"] },
    { q: "ê³ ê¸°ì•• ì§€ì—­ì˜ ë‚ ì”¨ëŠ” ëŒ€ì²´ë¡œ ì–´ë– í•œê°€ìš”?", a: "ë§‘ë‹¤", w: ["íë¦¬ë‹¤", "ë¹„ê°€ ì˜¨ë‹¤"] },
    { q: "ì €ê¸°ì•• ì§€ì—­ì˜ ë‚ ì”¨ëŠ” ëŒ€ì²´ë¡œ ì–´ë– í•œê°€ìš”?", a: "íë¦¬ê±°ë‚˜ ë¹„ê°€ ì˜¨ë‹¤", w: ["ë§‘ë‹¤", "ê±´ì¡°í•˜ë‹¤"] },
    { q: "í–‡ë¹›ì´ ì˜¤ë«ë™ì•ˆ ë‚´ë¦¬ì¬ì–´ì„œ ì˜¨ë„ê°€ ë†’ì€ ì•¼ì™¸ì™€ ì—ì–´ì»¨ì„ í‹€ì–´ë†“ì€ ì‹¤ë‚´ ì¤‘ ì–´ëŠ ê³³ì˜ ê¸°ì••ì´ ë” ë†’ì„ê¹Œ?", a: "ì‹¤ë‚´", w: ["ì•¼ì™¸", "ê¸°ì••ì´ ê°™ë‹¤"] },

    // [ì˜¨ë„ì™€ ì—´]
    { q: "ê³ ì²´ì—ì„œ ì—´ì´ ì˜¨ë„ê°€ ë†’ì€ ê³³ì—ì„œ ë‚®ì€ ê³³ìœ¼ë¡œ ì´ë™í•˜ëŠ” í˜„ìƒì€?", a: "ì „ë„", w: ["ëŒ€ë¥˜", "ë‹¨ì—´"] },
    { q: "ê¸ˆì† ë§‰ëŒ€ì˜ í•œìª½ ëì„ ê°€ì—´í•˜ë©´ ì—´ì€ ì–´ë–»ê²Œ ì´ë™í• ê¹Œìš”?", a: "ê°€ì—´í•œ ê³³ì—ì„œ ë©€ì–´ì§€ëŠ” ë°©í–¥ìœ¼ë¡œ ì´ë™", w: ["ê°€ì—´í•œ ë¶€ë¶„ì—ë§Œ ë¨¸ë¬¸ë‹¤", "ì˜¨ë„ê°€ ë‚®ì€ ê³³ì—ì„œ ë†’ì€ ê³³ìœ¼ë¡œ ì´ë™"] },
    { q: "ì•¡ì²´ë‚˜ ê¸°ì²´ì—ì„œ ì˜¨ë„ê°€ ë†’ì•„ì§„ ë¬¼ì§ˆì´ ìœ„ë¡œ ì˜¬ë¼ê°€ëŠ” ì—´ì˜ ì´ë™ ë°©ì‹ì€?", a: "ëŒ€ë¥˜", w: ["ì „ë„", "ë³µì‚¬"] },
    { q: "ì£¼ì „ì ì†ì˜ ë¬¼ì´ ì „ì²´ì ìœ¼ë¡œ ë”°ëœ»í•´ì§€ëŠ” ì´ìœ ëŠ” ë¬´ì—‡ ë•Œë¬¸ì¼ê¹Œìš”?", a: "ëŒ€ë¥˜", w: ["ì „ë„", "ë‹¨ì—´"] },
    { q: "ì—´ì˜ ì´ë™ì„ ë§‰ì•„ ì˜¨ë„ë¥¼ ìœ ì§€í•˜ëŠ” ê²ƒì„ ë¬´ì—‡ì´ë¼ê³  í•˜ë‚˜ìš”?", a: "ë‹¨ì—´", w: ["ì „ë„", "ëŒ€ë¥˜"] },
    { q: "ë³´ì˜¨ë³‘ì˜ ë²½ì„ ì´ì¤‘ìœ¼ë¡œ ë§Œë“¤ê³  ê·¸ ì‚¬ì´ë¥¼ ë¹„ìš°ëŠ” ëª©ì ì€?", a: "ì—´ì˜ ì´ë™ì„ ë§‰ê¸° ìœ„í•´", w: ["ë¬´ê²Œë¥¼ ê°€ë³ê²Œ í•˜ê¸° ìœ„í•´", "ëª¨ì–‘ì„ ì˜ˆì˜ê²Œ ë§Œë“¤ê¸° ìœ„í•´"] },
    { q: "ë‹¤ìŒ ì¤‘ ì „ë„ê°€ ê°€ì¥ ì˜ ì¼ì–´ë‚˜ëŠ” ë¬¼ì§ˆì€?", a: "êµ¬ë¦¬", w: ["ë‚˜ë¬´", "ìœ ë¦¬"] },
    { q: "ë‹¤ìŒ ì¤‘ ì—´ì˜ ì „ë„ê°€ ê°€ì¥ ëŠë¦¬ê²Œ ë˜ëŠ” ë¬¼ì§ˆì€?", a: "ë‚˜ë¬´", w: ["êµ¬ë¦¬", "ì² "] },

    // [íƒœì–‘ê³„ì™€ ë³„]
    { q: "ìŠ¤ìŠ¤ë¡œ ë¹›ì„ ë‚´ëŠ” íƒœì–‘ê³„ì˜ ìœ ì¼í•œ ë³„ì€?", a: "íƒœì–‘", w: ["ì§€êµ¬", "ë‹¬"] },
    { q: "íƒœì–‘ê³„ í–‰ì„± ì¤‘ íƒœì–‘ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ í–‰ì„±ì€?", a: "ìˆ˜ì„±", w: ["ê¸ˆì„±", "ì§€êµ¬"] },
    { q: "íƒœì–‘ê³„ í–‰ì„± ì¤‘ í¬ê¸°ê°€ ê°€ì¥ í° í–‰ì„±ì€?", a: "ëª©ì„±", w: ["í† ì„±", "ì²œì™•ì„±"] },
    { q: "íƒœì–‘ê³„ í–‰ì„± ì¤‘ í¬ê¸°ê°€ ê°€ì¥ ì‘ì€ í–‰ì„±ì€?", a: "ìˆ˜ì„±", w: ["ëª©ì„±", "ì§€êµ¬"] },
    { q: "íƒœì–‘ì—ì„œ í–‰ì„±ê¹Œì§€ì˜ ê±°ë¦¬ë¥¼ ë¹„êµí•  ë•Œ ê°€ì¥ ë©€ë¦¬ ìˆëŠ” í–‰ì„±ì€?", a: "í•´ì™•ì„±", w: ["í™”ì„±", "í† ì„±"] },
    { q: "ë¶ìª½ í•˜ëŠ˜ì—ì„œ ìœ„ì¹˜ê°€ ê±°ì˜ ë³€í•˜ì§€ ì•Šì•„ ë°©í–¥ì˜ ê¸°ì¤€ì´ ë˜ëŠ” ë³„ì€?", a: "ë¶ê·¹ì„±", w: ["ì‹œë¦¬ìš°ìŠ¤", "ê²¬ìš°ì„±"] },
    { q: "ë¶ê·¹ì„±ì„ ì°¾ê¸° ìœ„í•´ ì´ìš©í•˜ëŠ” êµ­ì ëª¨ì–‘ì˜ ë³„ìë¦¬ëŠ”?", a: "ë¶ë‘ì¹ ì„±", w: ["ì‚¬ììë¦¬", "ì˜¤ë¦¬ì˜¨ìë¦¬"] },
    { q: "ë³„ê³¼ í–‰ì„±ì˜ ì°¨ì´ì  ì¤‘ ë§ëŠ” ê²ƒì€?", a: "ë³„ì€ ìŠ¤ìŠ¤ë¡œ ë¹›ì„ ë‚´ì§€ë§Œ í–‰ì„±ì€ ê·¸ë ‡ì§€ ëª»í•˜ë‹¤", w: ["í–‰ì„±ì´ ìŠ¤ìŠ¤ë¡œ ë¹›ì„ ë‚¸ë‹¤", "ë‘˜ ë‹¤ ìŠ¤ìŠ¤ë¡œ ë¹›ì„ ë‚¸ë‹¤"] },
    { q: "ì¹´ì‹œì˜¤í˜ì´ì•„ìë¦¬ëŠ” ì–´ë–¤ ëª¨ì–‘ì¸ê°€ìš”?", a: "'W'ì ëª¨ì–‘", w: ["êµ­ì ëª¨ì–‘", "ì‚¬ì ëª¨ì–‘"] },
    { q: "ë°¤í•˜ëŠ˜ì—ì„œ ë©°ì¹  ë™ì•ˆ ê´€ì°°í–ˆì„ ë•Œ ìœ„ì¹˜ê°€ ë³€í•˜ëŠ” ì²œì²´ëŠ”?", a: "í–‰ì„±", w: ["ë³„", "ë³„ìë¦¬"] },
    { q: "ë°¤í•˜ëŠ˜ì—ì„œ ë©°ì¹  ë™ì•ˆ ê´€ì°°í–ˆì„ ë•Œ ìœ„ì¹˜ê°€ ë³€í•˜ì§€ ì•ŠëŠ” ì²œì²´ëŠ”?", a: "ë³„", w: ["í–‰ì„±", "ê·¸ëŸ° ì²œì²´ëŠ” ì—†ë‹¤"] },

    // [ìš©í•´ì™€ ìš©ì•¡]
    { q: "ì„¤íƒ•ì´ ë¬¼ì— ë…¹ì•„ ì„ì´ëŠ” í˜„ìƒì„ ë¬´ì—‡ì´ë¼ê³  í•˜ë‚˜ìš”?", a: "ìš©í•´", w: ["ìœµí•´", "ì‘ê³ "] },
    { q: "ì„¤íƒ•ë¬¼ì—ì„œ ì„¤íƒ•ì²˜ëŸ¼ ë…¹ëŠ” ë¬¼ì§ˆì„ ë¬´ì—‡ì´ë¼ê³  í•˜ë‚˜ìš”?", a: "ìš©ì§ˆ", w: ["ìš©ë§¤", "ìš©ì•¡"] },
    { q: "ì„¤íƒ•ë¬¼ì—ì„œ ë¬¼ì²˜ëŸ¼ ë…¹ì´ëŠ” ë¬¼ì§ˆì„ ë¬´ì—‡ì´ë¼ê³  í•˜ë‚˜ìš”?", a: "ìš©ë§¤", w: ["ìš©ì§ˆ", "ìš©ì•¡"] },
    { q: "ì„¤íƒ•ë¬¼ì„ ë‹¤ ë§Œë“¤ì—ˆì„ ë•Œ, ì„¤íƒ•ê³¼ ë¬¼ì´ ê³ ë¥´ê²Œ ì„ì¸ ìƒíƒœë¥¼ ë¬´ì—‡ì´ë¼ í•˜ë‚˜ìš”?", a: "ìš©ì•¡", w: ["ìš©ì§ˆ", "ìš©ë§¤"] },
    { q: "íˆ¬ëª…í•œ ë‘ ì„¤íƒ•ë¬¼ì˜ ì§„í•˜ê¸°ë¥¼ ë¹„êµí•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ì˜³ì€ ê²ƒì€?", a: "ë§›ì„ ë³´ê±°ë‚˜ ë¬¼ì²´ë¥¼ ë„ì›Œ ë¹„êµí•œë‹¤", w: ["ë¹›ì„ ë¹„ì¶”ì–´ ë³¸ë‹¤", "ëƒ„ìƒˆë¥¼ ë§¡ì•„ ë¹„êµí•œë‹¤"] },
    { q: "ì¼ì •í•œ ì–‘ì˜ ë¬¼ì— ì†Œê¸ˆì„ ê³„ì† ë„£ìœ¼ë©´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?", a: "ì–´ëŠ ì •ë„ ë…¹ë‹¤ê°€ ë” ì´ìƒ ë…¹ì§€ ì•ŠëŠ”ë‹¤", w: ["ëì—†ì´ ë…¹ëŠ”ë‹¤", "ë¬¼ì´ ì‚¬ë¼ì§„ë‹¤"] },
    { q: "ì†Œê¸ˆì„ ë” ë§ì´ ë…¹ì´ë ¤ë©´ ë¬¼ì„ ì–´ë–»ê²Œ í•´ì•¼ í•˜ë‚˜ìš”?", a: "ë¬¼ì˜ ì˜¨ë„ë¥¼ ë†’ì¸ë‹¤", w: ["ë¬¼ì˜ ì–‘ì„ ì¤„ì¸ë‹¤", "ë¶€ì±„ë¡œ ë°”ëŒì„ ì¼ìœ¼í‚¨ë‹¤"] },
    { q: "2ê°€ì§€ ì„¤íƒ•ë¬¼ì— ë°©ìš¸í† ë§ˆí† ë¥¼ ë„£ì—ˆì„ ë•Œ ë°©ìš¸í† ë§ˆí† ê°€ ë” ë†’ì´ ë– ì˜¤ë¥¸ ì„¤íƒ•ë¬¼ì€?", a: "ë” ì§„í•˜ë‹¤", w: ["ë” ì—°í•˜ë‹¤", "ì•Œ ìˆ˜ ì—†ë‹¤"] },
    { q: "2ê°€ì§€ ì„¤íƒ•ë¬¼ì— ë°©ìš¸í† ë§ˆí† ë¥¼ ë„£ì—ˆì„ ë•Œ ë°©ìš¸í† ë§ˆí† ê°€ ë” ë‚®ê²Œ ëœ¨ê±°ë‚˜ ê°€ë¼ì•‰ì€ ì„¤íƒ•ë¬¼ì€?", a: "ë” ì—°í•˜ë‹¤", w: ["ë” ì§„í•˜ë‹¤", "ì•Œ ìˆ˜ ì—†ë‹¤"] },
    
    // [ë‹¤ì–‘í•œ ìƒë¬¼ê³¼ ìš°ë¦¬ ìƒí™œ]
    { q: "ëˆˆì— ë³´ì´ì§€ ì•ŠëŠ” ì‘ì€ ìƒë¬¼ì„ ê´€ì°°í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ë„êµ¬ëŠ”?", a: "ê´‘í•™ í˜„ë¯¸ê²½", w: ["ë§ì›ê²½", "ë‹ë³´ê¸°"] },
    { q: "ê³°íŒ¡ì´ë‚˜ ë²„ì„¯ì²˜ëŸ¼ í¬ìë¡œ ë²ˆì‹í•˜ëŠ” ìƒë¬¼ ë¬´ë¦¬ëŠ”?", a: "ê· ë¥˜", w: ["ì›ìƒ ìƒë¬¼", "ì‹ë¬¼"] },
    { q: "ë¬¼ì†ì— ì‚´ë©° ëª¸ì´ ì´ˆë¡ìƒ‰ ì„  ëª¨ì–‘ì¸ ì›ìƒ ìƒë¬¼ì€?", a: "í•´ìº„", w: ["ì§šì‹ ë²Œë ˆ", "ì„¸ê· "] },
    { q: "ì§šì‹  ëª¨ì–‘ì„ ë‹®ì•˜ìœ¼ë©° ìŠ¤ìŠ¤ë¡œ ì›€ì§ì´ëŠ” ì›ìƒ ìƒë¬¼ì€?", a: "ì§šì‹ ë²Œë ˆ", w: ["í•´ìº„", "ê³°íŒ¡ì´"] },
    { q: "ê· ë¥˜ê°€ ì˜ ìë¼ëŠ” í™˜ê²½ì€?", a: "ë”°ëœ»í•˜ê³  ìŠµê¸°ê°€ ë§ì€ ê³³", w: ["ê±´ì¡°í•œ ê³³", "í–‡ë¹›ì´ ê°•í•œ ê³³"] },
    { q: "ìš°ë¦¬ ì£¼ë³€ ì–´ë””ì—ë‚˜ ìˆìœ¼ë©° ì¡°ê±´ì— ë§ìœ¼ë©´ ìˆ˜ê°€ ë¹ ë¥´ê²Œ ëŠ˜ì–´ë‚˜ëŠ” êµ¬ì¡°ê°€ ë‹¨ìˆœí•œ ìƒë¬¼ì€?", a: "ì„¸ê· ", w: ["ê· ë¥˜", "ë™ë¬¼"] },
    { q: "ìœ ì‚°ê· ì²˜ëŸ¼ ìš°ë¦¬ ìƒí™œì— ë„ì›€ì„ ì£¼ëŠ” ì„¸ê· ì˜ ì—­í• ì€?", a: "ìŒì‹ ë°œíš¨", w: ["ì§ˆë³‘ ìœ ë°œ", "ìŒì‹ ë¶€íŒ¨"] },
    { q: "ê³°íŒ¡ì´ê°€ ìš°ë¦¬ì—ê²Œ ì£¼ëŠ” í•´ë¡œìš´ ì ì€?", a: "ìŒì‹ ë¶€íŒ¨", w: ["ì‚°ì†Œ ê³µê¸‰", "ì˜ì–‘ë¶„ ìƒì„±"] },
    { q: "ì›ìƒ ìƒë¬¼ì— ëŒ€í•œ ì„¤ëª…ìœ¼ë¡œ ì˜³ì€ ê²ƒì€?", a: "ì£¼ë¡œ ë¬¼ê¸°ê°€ ìˆëŠ” ê³³ì— ì‚°ë‹¤", w: ["ì‹ë¬¼ê³¼ ë˜‘ê°™ë‹¤", "ëˆˆìœ¼ë¡œ ì‰½ê²Œ ë³´ì¸ë‹¤"] },
    { q: "ì›ìƒ ìƒë¬¼ì— ëŒ€í•œ ì„¤ëª…ìœ¼ë¡œ ì˜³ì€ ê²ƒì€?", a: "ë™ë¬¼ë„ ì‹ë¬¼ë„ ê· ë¥˜ë„ ì•„ë‹ˆë‹¤", w: ["ë™ë¬¼ì´ë‹¤", "ê· ë¥˜ì´ë‹¤"] },

    // [ìƒë¬¼ê³¼ í™˜ê²½]
    { q: "ìƒíƒœê³„ì—ì„œ í–‡ë¹›ìœ¼ë¡œ ì–‘ë¶„ì„ ì§ì ‘ ë§Œë“œëŠ” ìƒë¬¼ì€?", a: "ìƒì‚°ì", w: ["ì†Œë¹„ì", "ë¶„í•´ì"] },
    { q: "ìŠ¤ìŠ¤ë¡œ ì–‘ë¶„ì„ ë§Œë“¤ì§€ ëª»í•˜ê³  ë‹¤ë¥¸ ìƒë¬¼ì„ ë¨¹ì–´ì•¼ í•˜ëŠ” ìƒë¬¼ì€?", a: "ì†Œë¹„ì", w: ["ìƒì‚°ì", "ë¶„í•´ì"] },
    { q: "ë‹¤ë¥¸ ìƒë¬¼ì„ ë¨¹ì´ë¡œ í•˜ì—¬ ì–‘ë¶„ì„ ì–»ëŠ” ìƒë¬¼ì€?", a: "ì†Œë¹„ì", w: ["ìƒì‚°ì", "ë¶„í•´ì"] },
    { q: "ì£½ì€ ìƒë¬¼ì„ ë¶„í•´í•˜ì—¬ ì–‘ë¶„ì„ ì–»ëŠ” ìƒë¬¼ì€?", a: "ë¶„í•´ì", w: ["ìƒì‚°ì", "ì†Œë¹„ì"] },
    { q: "ìƒë¬¼ ì£¼ë³€ì˜ í–‡ë¹›, ë¬¼, ì˜¨ë„ ë“±ì„ ë¬´ì—‡ì´ë¼ í•˜ë‚˜ìš”?", a: "ë¹„ìƒë¬¼ ìš”ì†Œ", w: ["ìƒë¬¼ ìš”ì†Œ", "ì‚¬íšŒì  ìš”ì†Œ"] },
    { q: "ë¨¹ê³  ë¨¹íˆëŠ” ê´€ê³„ê°€ ì‚¬ìŠ¬ì²˜ëŸ¼ ì—°ê²°ëœ ê²ƒì€?", a: "ë¨¹ì´ì‚¬ìŠ¬", w: ["ë¨¹ì´ê·¸ë¬¼", "ë¨¹ì´í”¼ë¼ë¯¸ë“œ"] },
    { q: "ì—¬ëŸ¬ ê°œì˜ ë¨¹ì´ì‚¬ìŠ¬ì´ ê·¸ë¬¼ì²˜ëŸ¼ ë³µì¡í•˜ê²Œ ì—°ê²°ëœ ê²ƒì€?", a: "ë¨¹ì´ê·¸ë¬¼", w: ["ë¨¹ì´ì‚¬ìŠ¬", "ìƒë¬¼ ë†ì¶•"] },
    { q: "ìƒíƒœê³„ ë‚´ì—ì„œ ìƒë¬¼ì˜ ì¢…ë¥˜ì™€ ìˆ˜ê°€ ì¼ì •í•˜ê²Œ ìœ ì§€ë˜ëŠ” ìƒíƒœëŠ”?", a: "ìƒíƒœê³„ í‰í˜•", w: ["ìƒíƒœê³„ íŒŒê´´", "ìƒë¬¼ ë‹¤ì–‘ì„±"] },
    { q: "ìƒë¬¼ì´ í™˜ê²½ì— ë§ê²Œ ëª¸ì˜ í˜•íƒœë‚˜ ìŠµì„±ì´ ë³€í•˜ëŠ” ê²ƒì€?", a: "ì ì‘", w: ["ì´ë™", "íƒ„ìƒ"] },
    { q: "ê³°íŒ¡ì´ë‚˜ ì„¸ê· ì€ ìƒíƒœê³„ì—ì„œ ì–´ë–¤ ì—­í• ì„ í•˜ë‚˜ìš”?", a: "ë¶„í•´ì", w: ["ìƒì‚°ì", "ì†Œë¹„ì"] },
    { q: "ë¹„ìƒë¬¼ ìš”ì†Œ(ì˜¨ë„)ê°€ ìƒë¬¼ì— ì˜í–¥ì„ ì£¼ëŠ” ì‚¬ë¡€ëŠ”?", a: "ì² ìƒˆì˜ ì´ë™", w: ["ì§€ë ì´ê°€ í™ì„ ì¼êµ¬ëŠ” ê²ƒ", "ìˆ²ì´ ê³µê¸°ë¥¼ ë§‘ê²Œ í•˜ëŠ” ê²ƒ"] },

    // [ë¬¼ì²´ì˜ ìš´ë™]
    { q: "ë‹¨ìœ„ ì‹œê°„ ë™ì•ˆ ì´ë™í•œ ê±°ë¦¬ë¥¼ ë¬´ì—‡ì´ë¼ê³  í•˜ë‚˜ìš”?", a: "ì†ë ¥", w: ["ì‹œê°„", "ê±°ë¦¬"] },
    { q: "ê°™ì€ ê±°ë¦¬ë¥¼ ì´ë™í•  ë•Œ, ê±¸ë¦° ì‹œê°„ì´ ì§§ì„ìˆ˜ë¡ ë¹ ë¥´ê¸°ëŠ”?", a: "ë” ë¹ ë¥´ë‹¤", w: ["ë” ëŠë¦¬ë‹¤", "ê°™ë‹¤"] },
    { q: "ê°™ì€ ê±°ë¦¬ë¥¼ ì´ë™í•  ë•Œ, ê±¸ë¦° ì‹œê°„ì´ ê¸¸ìˆ˜ë¡ ë¹ ë¥´ê¸°ëŠ”?", a: "ë” ëŠë¦¬ë‹¤", w: ["ë” ë¹ ë¥´ë‹¤", "ê°™ë‹¤"] },
    { q: "ê°™ì€ ì‹œê°„ ë™ì•ˆ ì´ë™í•  ë•Œ, ì´ë™ ê±°ë¦¬ê°€ ê¸¸ìˆ˜ë¡ ë¹ ë¥´ê¸°ëŠ”?", a: "ë” ë¹ ë¥´ë‹¤", w: ["ë” ëŠë¦¬ë‹¤", "ê°™ë‹¤"] },
    { q: "ê°™ì€ ì‹œê°„ ë™ì•ˆ ì´ë™í•  ë•Œ, ì´ë™ ê±°ë¦¬ê°€ ì§§ì„ìˆ˜ë¡ ë¹ ë¥´ê¸°ëŠ”?", a: "ë” ëŠë¦¬ë‹¤", w: ["ë” ë¹ ë¥´ë‹¤", "ê°™ë‹¤"] },
    { q: "ì†ë ¥ì„ êµ¬í•˜ëŠ” ì˜¬ë°”ë¥¸ ë°©ë²•ì€?", a: "ê±°ë¦¬ Ã· ì‹œê°„", w: ["ì‹œê°„ Ã· ê±°ë¦¬", "ê±°ë¦¬ Ã— ì‹œê°„"] },
    { q: "1ì‹œê°„ ë™ì•ˆ 30km ì›€ì§ì´ëŠ” ë¬¼ì²´ì˜ ì†ë ¥ì€?", a: "30km/h", w: ["30km/s", "30km/m"] },
    { q: "1ì´ˆ ë™ì•ˆ 30km ì›€ì§ì´ëŠ” ë¬¼ì²´ì˜ ì†ë ¥ì€?", a: "30km/s", w: ["30km/h", "30km/m"] },
    { q: "1ë¶„ ë™ì•ˆ 30km ì›€ì§ì´ëŠ” ë¬¼ì²´ì˜ ì†ë ¥ì€?", a: "30km/m", w: ["30km/s", "30km/h"] },
    { q: "10ì´ˆ ë™ì•ˆ 100më¥¼ ë‹¬ë¦° ì‚¬ëŒì˜ ì†ë ¥ì€?", a: "10m/s", w: ["1m/s", "100m/s"] },
    { q: "ë¹ ë¥´ê¸°ê°€ ì¼ì •í•œ ìš´ë™ì˜ ì˜ˆëŠ”?", a: "ì—ìŠ¤ì»¬ë ˆì´í„°", w: ["ë–¨ì–´ì§€ëŠ” ê³µ", "ì¶œë°œí•˜ëŠ” ê¸°ì°¨"] },
    { q: "ë¹ ë¥´ê¸°ê°€ ì¼ì •í•œ ìš´ë™ì˜ ì˜ˆëŠ”?", a: "ëŒ€ê´€ëŒì°¨", w: ["ë°”ì´í‚¹", "ì¶œë°œí•˜ëŠ” ê¸°ì°¨"] },
    { q: "ë¹ ë¥´ê¸°ê°€ ë³€í•˜ëŠ” ìš´ë™ì˜ ì˜ˆëŠ”?", a: "ì¶œë°œí•˜ëŠ” ê¸°ì°¨", w: ["ì—ìŠ¤ì»¬ë ˆì´í„°", "ëŒ€ê´€ëŒì°¨"] },
    { q: "ë¹ ë¥´ê¸°ê°€ ë³€í•˜ëŠ” ìš´ë™ì˜ ì˜ˆëŠ”?", a: "ë‚ ì•„ê°€ëŠ” ì¶•êµ¬ê³µ", w: ["ëŒ€ê´€ëŒì°¨", "ì»¨ë² ì´ì–´ ë²¨íŠ¸"] },
    { q: "ë¹ ë¥´ê¸°ê°€ ì¼ì •í•œ ìš´ë™ì˜ ì˜ˆëŠ”?", a: "ì»¨ë² ì´ì–´ ë²¨íŠ¸", w: ["ì¶œë°œí•˜ëŠ” ê¸°ì°¨", "ë‚ ì•„ê°€ëŠ” ì¶•êµ¬ê³µ"] },
    { q: "100m ë‹¬ë¦¬ê¸° ê¸°ë¡ì´ AëŠ” 15ì´ˆ, BëŠ” 20ì´ˆë¼ë©´ ëˆ„ê°€ ë” ë¹ ë¥¸ê°€ìš”?", a: "A", w: ["B", "ë˜‘ê°™ë‹¤"] },
    { q: "100m ë‹¬ë¦¬ê¸° ê¸°ë¡ì´ AëŠ” 15ì´ˆ, BëŠ” 10ì´ˆë¼ë©´ ëˆ„ê°€ ë” ë¹ ë¥¸ê°€ìš”?", a: "B", w: ["A", "ë˜‘ê°™ë‹¤"] },

    // [ì‚°ê³¼ ì—¼ê¸°]
    { q: "ìš©ì•¡ì˜ ì„±ì§ˆì— ë”°ë¼ ìƒ‰ê¹”ì´ ë³€í•˜ëŠ” ë¬¼ì§ˆì€?", a: "ì§€ì‹œì•½", w: ["ìš©ë§¤", "ìš©ì§ˆ"] },
    { q: "í‘¸ë¥¸ìƒ‰ ë¦¬íŠ¸ë¨¸ìŠ¤ ì¢…ì´ë¥¼ ë¶‰ê²Œ ë³€í™”ì‹œí‚¤ëŠ” ìš©ì•¡ì€?", a: "ì‚°ì„± ìš©ì•¡", w: ["ì—¼ê¸°ì„± ìš©ì•¡", "ì¤‘ì„± ìš©ì•¡"] },
    { q: "ë¶‰ì€ìƒ‰ ë¦¬íŠ¸ë¨¸ìŠ¤ ì¢…ì´ë¥¼ í‘¸ë¥´ê²Œ ë³€í™”ì‹œí‚¤ëŠ” ìš©ì•¡ì€?", a: "ì—¼ê¸°ì„± ìš©ì•¡", w: ["ì‚°ì„± ìš©ì•¡", "ì¤‘ì„± ìš©ì•¡"] },
    { q: "í˜ë†€í”„íƒˆë ˆì¸ ìš©ì•¡ì„ ë¶‰ê²Œ ë³€í™”ì‹œí‚¤ëŠ” ìš©ì•¡ì€?", a: "ì—¼ê¸°ì„± ìš©ì•¡", w: ["ì‚°ì„± ìš©ì•¡", "ì¤‘ì„± ìš©ì•¡"] },
    { q: "í˜ë†€í”„íƒˆë ˆì¸ ìš©ì•¡ì„ ë–¨ì–´ëœ¨ë ¸ì„ ë•Œ ìƒ‰ê¹”ì´ ë³€í•˜ì§€ ì•ŠëŠ” ìš©ì•¡ì€?", a: "ì‚°ì„± ìš©ì•¡", w: ["ì—¼ê¸°ì„± ìš©ì•¡", "ë¹„ëˆ—ë¬¼"] },
    { q: "ë‹¤ìŒ ì¤‘ ëŒ€í‘œì ì¸ ì‚°ì„± ìš©ì•¡ì€?", a: "ì‹ì´ˆ", w: ["ë¹„ëˆ—ë¬¼", "ì„íšŒìˆ˜"] },
    { q: "ë‹¤ìŒ ì¤‘ ëŒ€í‘œì ì¸ ì—¼ê¸°ì„± ìš©ì•¡ì€?", a: "ì„íšŒìˆ˜", w: ["ì‹ì´ˆ", "ë ˆëª¬ì¦™"] },
    { q: "ë‹¤ìŒ ì¤‘ ëŒ€í‘œì ì¸ ì—¼ê¸°ì„± ìš©ì•¡ì€?", a: "ë¹„ëˆ—ë¬¼", w: ["ë ˆëª¬ì¦™", "ì‚¬ì´ë‹¤"] },
    { q: "ë‹¤ìŒ ì¤‘ ëŒ€í‘œì ì¸ ì‚°ì„± ìš©ì•¡ì€?", a: "ë ˆëª¬ì¦™", w: ["ë¹„ëˆ—ë¬¼", "ì„íšŒìˆ˜"] },
    { q: "ì‚°ì„± ìš©ì•¡ì— ë‹¬ê±€ ê»ë°ê¸°ë¥¼ ë„£ìœ¼ë©´ ì–´ë–¤ ë³€í™”ê°€ ìƒê¸°ë‚˜ìš”?", a: "ê¸°í¬ê°€ ë°œìƒí•˜ë©° ë…¹ëŠ”ë‹¤", w: ["ë³€í™” ì—†ë‹¤", "ë”±ë”±í•´ì§„ë‹¤"] },
    { q: "ë‹¬ê±€ ê»ë°ê¸°ë¥¼ ë„£ì—ˆì„ë•Œ ê¸°í¬ê°€ ìƒê¸°ë„ë¡ í•˜ëŠ” ìš©ì•¡ì€?", a: "ì‚°ì„± ìš©ì•¡", w: ["ì—¼ê¸°ì„± ìš©ì•¡", "ë¹„ëˆ—ë¬¼"] },
    { q: "ì—¼ê¸°ì„± ìš©ì•¡ì˜ ê³µí†µì ì¸ íŠ¹ì§•ì€?", a: "ë‘ë¶€ë‚˜ ê³„ë€ í°ì ê°™ì€ ë¬¼ì§ˆì„ ë…¹ì¸ë‹¤", w: ["ì‹ ë§›ì´ ë‚œë‹¤", "ê¸ˆì†ì„ ë…¹ì¸ë‹¤"] },
    { q: "ë‘ë¶€ë‚˜ ê³„ë€ í°ì ê°™ì€ ë¬¼ì§ˆì„ ë…¹ì´ëŠ” ìš©ì•¡ì€?", a: "ì—¼ê¸°ì„± ìš©ì•¡", w: ["ì‚°ì„± ìš©ì•¡", "ì‹ì´ˆ"] },
    { q: "ì‚°ì„± ìš©ì•¡ê³¼ ì—¼ê¸°ì„± ìš©ì•¡ì„ ì„ìœ¼ë©´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?", a: "ê° ìš©ì•¡ì˜ ì„±ì§ˆì´ ì•½í•´ì§„ë‹¤", w: ["ì„±ì§ˆì´ ë” ê°•í•´ì§„ë‹¤", "ì•„ë¬´ ë³€í™” ì—†ë‹¤"] },
    { q: "ìƒì„  ë¹„ë¦°ë‚´(ì—¼ê¸°ì„±)ì— ë ˆëª¬ì¦™ì„ ë¿Œë¦¬ëŠ” ì´ìœ ëŠ”?", a: "ì‚°ì„±ìœ¼ë¡œ ì¤‘í™”í•˜ë ¤ê³ ", w: ["ì—¼ê¸°ì„±ìœ¼ë¡œ ì¤‘í™”í•˜ë ¤ê³ ", "ë§›ì„ ì—†ì• ë ¤ê³ "] },
    { q: "ìœ„ì‚°(ì‚°ì„±) ë•Œë¬¸ì— ì†ì´ ì“°ë¦´ ë•Œ ë¨¹ëŠ” ì œì‚°ì œë¥¼ ë¨¹ëŠ” ì´ìœ ëŠ”?", a: "ì—¼ê¸°ì„±ìœ¼ë¡œ ì¤‘í™”í•˜ë ¤ê³ ", w: ["ì‚°ì„±ìœ¼ë¡œ ì¤‘í™”í•˜ë ¤ê³ ", "ê°ê°ì„ ë‘”í•˜ê²Œ í•œë‹¤"] },
    { q: "ìì£¼ìƒ‰ ì–‘ë°°ì¶” ì§€ì‹œì•½ì´ ë¶‰ì€ìƒ‰ìœ¼ë¡œ ë³€í–ˆë‹¤ë©´ ê·¸ ìš©ì•¡ì€?", a: "ì‚°ì„±", w: ["ì—¼ê¸°ì„±", "ì¤‘ì„±"] },
    { q: "ì†ì´ ì“°ë¦´ ë•Œ ë¨¹ëŠ” ì œì‚°ì œëŠ” ì–´ë–¤ ì„±ì§ˆì¼ê¹Œìš”?", a: "ì—¼ê¸°ì„±", w: ["ì‚°ì„±", "ì¤‘ì„±"] },
    { q: "ì‚°ì„± ìš©ì•¡ì— ëŒ€ë¦¬ì„ ì¡°ê°ì„ ë„£ìœ¼ë©´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?", a: "ëŒ€ë¦¬ì„ì´ ë…¹ëŠ”ë‹¤", w: ["ëŒ€ë¦¬ì„ì´ ì»¤ì§„ë‹¤", "ë³€í™” ì—†ë‹¤"] }
];

/**
 * 2. ê²Œì„ ìƒíƒœ ë³€ìˆ˜
 */
let gameState = 'START'; // START, PLAYING, PAUSED, GAMEOVER
let frameCount = 0;
let score = 0;
let gameSpeed = 1.2;
let isBossBattleMode = false; // ë³´ìŠ¤ì „ ëª¨ë“œ (ì •ì§€)
let scrollOffset = 0; // ë°°ê²½ ìŠ¤í¬ë¡¤ìš©

// í†µê³„ ë³€ìˆ˜
let nickname = "í•™ìƒ";
let totalCorrect = 0;
let totalWrong = 0; // ì˜¤ë‹µ íšŸìˆ˜ ì¶”ê°€
let consecutiveCorrect = 0;
let maxCombo = 0;

// ì „ì—­ í†µê³„ ë³€ìˆ˜ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—°ë™)
let globalStats = {
    bestScore: 0,
    bestCorrect: 0,
    bestMaxCombo: 0,
    lifetimeCorrect: 0,
    lifetimeAttempts: 0
};

// ê°ì²´ ë°°ì—´
let bullets = [];
let enemies = [];
let gates = [];
let particles = [];
let floatingTexts = [];
let items = []; // ì•„ì´í…œ ë°°ì—´ ì¶”ê°€

// ë³´ìŠ¤ ê´€ë ¨ ë³€ìˆ˜
let boss = null;
let bossSpawnScore = 1000; // ì²« ë³´ìŠ¤ ë“±ì¥ ì ìˆ˜

// ì•„ì´í…œ íš¨ê³¼ ë³€ìˆ˜
let shieldActive = false;
let shieldTimer = 0;
let feverActive = false;
let feverTimer = 0;
let currentQuestionObj = null;
let nextGateFrame = 0;
let player;
let targetX;

/**
 * 3. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ì…”í”Œ, ì €ì¥ ë“±)
 */
// ë°°ì—´ ì„ê¸° (Fisher-Yates)
function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤
const SAVE_KEY = 'weatherRun_save_v2';
const RECORD_KEY = 'weatherRun_records_v2';
const STATS_KEY = 'weatherRun_stats_v1';
const CURRENT_NICKNAME_KEY = 'weatherRun_current_nickname'; // í˜„ì¬ ë‹‰ë„¤ì„ í‚¤ ì¶”ê°€
const SECRET_SALT = "science_run_secret_salt_2025"; // í•´ì‹œìš© ì†”íŠ¸

// [ì¤‘ìš”] ì—¬ê¸°ì— ì•±ìŠ¤í¬ë¦½íŠ¸ ë°°í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”.
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxops2fGy-Gwo5YAqhmc4B3h09tHNl42cf1fzyMLTMc6DYUKyaKt22kbegmp_HzfuIx/exec";

// ê°„ë‹¨í•œ í•´ì‹œ í•¨ìˆ˜ (ë¬´ê²°ì„± ê²€ì¦ìš©)
function generateHash(data) {
    const str = JSON.stringify(data) + SECRET_SALT;
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
    }
    return hash.toString();
}

// ë°ì´í„° ì•”í˜¸í™” (Base64 ì¸ì½”ë”© + ê°„ë‹¨í•œ XOR)
function encryptData(data) {
    const jsonStr = JSON.stringify(data);
    const hash = generateHash(data);
    const combined = hash + "|" + jsonStr; // í•´ì‹œ + ë°ì´í„°
    return btoa(unescape(encodeURIComponent(combined))); // Base64 ì¸ì½”ë”© (í•œê¸€ ì²˜ë¦¬ í¬í•¨)
}

// ë°ì´í„° ë³µí˜¸í™” ë° ê²€ì¦
function decryptAndVerify(encryptedStr) {
    try {
        const decoded = decodeURIComponent(escape(atob(encryptedStr)));
        const splitIdx = decoded.indexOf("|");
        if (splitIdx === -1) return null;

        const hash = decoded.substring(0, splitIdx);
        const jsonStr = decoded.substring(splitIdx + 1);
        const data = JSON.parse(jsonStr);

        // í•´ì‹œ ì¬ê³„ì‚°í•˜ì—¬ ê²€ì¦
        if (generateHash(data) === hash) {
            return data;
        } else {
            console.warn("ë°ì´í„° ë³€ì¡° ê°ì§€ë¨! ì´ˆê¸°í™”í•©ë‹ˆë‹¤.");
            return null;
        }
    } catch (e) {
        console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", e);
        return null;
    }
}

// ì „ì—­ í†µê³„ ë¡œë“œ
function loadGlobalStats() {
    const encryptedStats = localStorage.getItem(STATS_KEY);
    if (encryptedStats) {
        const data = decryptAndVerify(encryptedStats);
        if (data) {
            globalStats = data;
        } else {
            // ë³€ì¡°ë˜ì—ˆê±°ë‚˜ ì˜¤ë¥˜ ì‹œ ì´ˆê¸°í™”
            globalStats = {
                bestScore: 0,
                bestCorrect: 0,
                bestMaxCombo: 0,
                lifetimeCorrect: 0,
                lifetimeAttempts: 0
            };
        }
    }
    updateHUDStats(); 
}

// ì „ì—­ í†µê³„ ì €ì¥
function saveGlobalStats() {
    const encrypted = encryptData(globalStats);
    localStorage.setItem(STATS_KEY, encrypted);
}

// ê²Œì„ ì €ì¥
function saveGame() {
    if (gameState !== 'PLAYING' && gameState !== 'PAUSED') return;
    
    const saveData = {
        score, totalCorrect, totalWrong, consecutiveCorrect, maxCombo, nickname, frameCount, nextGateFrame,
        player: { x: player.x, y: player.y, soldiers: player.soldiers },
        enemies: enemies.map(e => ({x: e.x, y: e.y, hp: e.hp})),
        gates: gates.map(g => ({x: g.x, y: g.y, width: g.width, text: g.text, isCorrect: g.isCorrect, passed: g.passed})),
        currentQuestionObj
    };
    localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
}

// ì €ì¥ëœ ê²Œì„ í™•ì¸
function checkSavedGame() {
    return localStorage.getItem(SAVE_KEY) !== null;
}

    // ê²Œì„ ê¸°ë¡ ì €ì¥ (ê¸°ë¡ë„ ì•”í˜¸í™” ì ìš© ê¶Œì¥í•˜ë‚˜, ì—¬ê¸°ì„œëŠ” í†µê³„ ìœ„ì£¼ë¡œ ìš”ì²­ë°›ì•˜ìœ¼ë¯€ë¡œ ìœ ì§€í•˜ë˜ ë¬´ê²°ì„± ì²´í¬)
    function saveRecord() {
        let records = [];
        try {
            records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
        } catch(e) {
            records = [];
        }

        // ë¹„ì •ìƒì ì¸ ì ìˆ˜(Infinity, NaN ë“±) í•„í„°ë§
        if (!isFinite(score) || score < 0) score = 0;
        
        records.push({
            name: nickname.substring(0, 10), // ë‹‰ë„¤ì„ ê¸¸ì´ ì œí•œ ì¬í™•ì¸
            score: Math.floor(score),
            correct: totalCorrect,
            maxCombo: maxCombo, 
            date: new Date().toLocaleDateString()
        });
        // ì ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
        records.sort((a, b) => b.score - a.score);
        // ìƒìœ„ 10ê°œë§Œ ìœ ì§€
        records = records.slice(0, 10);
        localStorage.setItem(RECORD_KEY, JSON.stringify(records));
    }

/**
 * 4. í´ë˜ìŠ¤ ì •ì˜
 */
class Player {
    constructor(x, y, soldiers) {
        this.width = 40;
        this.height = 40;
        this.x = x ?? (GAME_WIDTH / 2 - 20);
        this.y = y ?? (GAME_HEIGHT - 150);
        this.soldiers = soldiers ?? 10;
        this.color = '#3498db';
        this.lastShotTime = 0;
    }

    update() {
        if (this.soldiers <= 0) endGame();

        // ë°œì‚¬ ì†ë„
        let fireRate = Math.max(100, 500 - (this.soldiers * 2));
        if (feverActive) fireRate = 50; // í”¼ë²„ ì‹œ ì´ˆê³ ì† ì—°ì‚¬

        const now = Date.now();
        if (now - this.lastShotTime > fireRate) {
            this.shoot();
            this.lastShotTime = now;
        }
        
        // ì•„ì´í…œ íƒ€ì´ë¨¸ ê°ì†Œ
        if (shieldActive) {
            shieldTimer--;
            if (shieldTimer <= 0) shieldActive = false;
        }
        if (feverActive) {
            feverTimer--;
            if (feverTimer <= 0) feverActive = false;
        }
    }

    draw() {
        const count = Math.floor(this.soldiers);
        const maxIndividualDraw = 30; 
        const cx = this.x + this.width / 2;
        const cy = this.y + this.height / 2;

        // ë³´í˜¸ë§‰ íš¨ê³¼ ê·¸ë¦¬ê¸°
        if (shieldActive) {
            ctx.strokeStyle = 'cyan';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(cx, cy, 60, 0, Math.PI * 2);
            ctx.stroke();
            ctx.globalAlpha = 0.3;
            ctx.fillStyle = 'cyan';
            ctx.fill();
            ctx.globalAlpha = 1.0;
        }

        // ... (ê¸°ì¡´ ìš°ì£¼ì„  ê·¸ë¦¬ê¸° ë¡œì§)

        let drawCount = count;
        let size = 60; 

        if (count <= maxIndividualDraw) {
            size = 70 / Math.sqrt(count);
            if(size > 60) size = 60;
            if(size < 20) size = 20;
        } else {
            drawCount = maxIndividualDraw;
            size = 20;
        }

        for(let i=0; i<drawCount; i++) {
             const angle = i * 2.4; 
             const dist = 7 * Math.sqrt(i);
             const rot = frameCount * 0.02;
             const dx = Math.cos(angle + rot) * dist;
             const dy = Math.sin(angle + rot) * dist;

             if (playerImg.complete && playerImg.naturalWidth > 0) {
                 ctx.drawImage(playerImg, cx + dx - size/2, cy + dy - size/2, size, size);
             } else {
                 ctx.fillStyle = this.color;
                 ctx.beginPath();
                 ctx.arc(cx + dx, cy + dy, size/2, 0, Math.PI*2);
                 ctx.fill();
             }
        }

        if (count > maxIndividualDraw) {
            ctx.fillStyle = 'white';
            ctx.font = 'bold 30px Arial';
            ctx.textAlign = 'center';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 4;
            ctx.strokeText(count, cx, cy - 50);
            ctx.fillText(count, cx, cy - 50);
        }
    }

    shoot() {
        // ë³‘ì‚¬ ìˆ˜ì— ë”°ë¼ ë°œì‚¬ì²´ ê°œìˆ˜ ë° íŒ¨í„´ ê²°ì • (ì´ˆë°˜ ë¹ ë¥¸ ì„±ì¥, í›„ë°˜ ì™„ë§Œ)
        let count = 1;
        
        if (this.soldiers < 20) count = 1;      // ~19: 1ë°œ
        else if (this.soldiers < 50) count = 2; // 20~49: 2ë°œ (ë¹ ë¥¸ ì„±ì¥)
        else if (this.soldiers < 100) count = 3;// 50~99: 3ë°œ
        else if (this.soldiers < 200) count = 4;// 100~199: 4ë°œ
        else if (this.soldiers < 500) count = 5;// 200~499: 5ë°œ
        else if (this.soldiers < 1000) count = 6;// 500~999: 6ë°œ
        else if (this.soldiers < 2500) count = 7;// 1000~2499: 7ë°œ (ì—¬ê¸°ì„œë¶€í„° ê°„ê²© ë„“ì–´ì§)
        else if (this.soldiers < 5000) count = 8;// 2500~4999: 8ë°œ
        else if (this.soldiers < 9000) count = 9;// 5000~8999: 9ë°œ
        else if (this.soldiers < 14000) count = 10;// 9000~13999: 10ë°œ
        else if (this.soldiers < 20000) count = 12;// 14000~19999: 12ë°œ
        else count = 15; // 20000ëª… ì´ìƒ: 15ë°œ (ìµœëŒ€ í™”ë ¥)

        // ê´‘í­í™”(Fever) ì‹œ ë°œì‚¬ì²´ 2ë°°
        if (feverActive) {
            count = Math.min(20, count * 2);
        }

        // ëŒ€ê°ì„  ë°œì‚¬ ì—¬ë¶€ (100ëª… ì´ìƒ í˜¹ì€ í”¼ë²„)
        const useSpread = this.soldiers >= 100 || feverActive;
        
        for(let i=0; i<count; i++) {
            let angle = 0;
            let startX = this.x + this.width/2;

            if (useSpread) {
                // ë¶€ì±„ê¼´ ë°œì‚¬ (ë³‘ì‚¬ê°€ ë§ì„ìˆ˜ë¡ ê°ë„ë„ ë„“ì–´ì§)
                // ìµœëŒ€ 20000ëª… ê¸°ì¤€ 1.2ë¼ë””ì•ˆê¹Œì§€ ë²Œì–´ì§
                let spreadFactor = Math.min(1.2, 0.3 + (this.soldiers / 10000));
                if (feverActive) spreadFactor = 1.5;

                if (count > 1) {
                    angle = -spreadFactor/2 + (spreadFactor / (count-1)) * i;
                }
            } else {
                const spreadX = 10;
                const offset = (i - (count-1)/2) * spreadX;
                startX += offset;
            }
            
            bullets.push(new Bullet(startX, this.y, angle));
        }
    }
}

class Bullet {
    constructor(x, y, angle = 0) {
        this.x = x;
        this.y = y;
        this.angle = angle;
        this.radius = 4;
        this.speed = 10;
        this.markedForDeletion = false;
    }
    update() {
        // angleì´ 0ì´ë©´ ìœ„ë¡œ(y ê°ì†Œ), ì–‘ìˆ˜ë©´ ì˜¤ë¥¸ìª½ ê¸°ìš¸ê¸°, ìŒìˆ˜ë©´ ì™¼ìª½ ê¸°ìš¸ê¸°
        this.x += Math.sin(this.angle) * this.speed;
        this.y -= Math.cos(this.angle) * this.speed;
        
        if (this.y < 0 || this.x < 0 || this.x > GAME_WIDTH) this.markedForDeletion = true;
    }
    draw() {
        ctx.fillStyle = '#f1c40f';
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fill();
    }
}

class Enemy {
    constructor(x, y, hp, packSize = 1, type = 'normal', hpMultiplier = 1) {
        this.width = 40;
        this.height = 40;
        this.x = x ?? Math.random() * (GAME_WIDTH - 40);
        this.y = y ?? -50;
        this.type = type; // normal, tank, speed, zigzag, pack, boss
        
        // ì†ë„ ë° í¬ê¸° ì„¤ì • (ê²Œì„ ì†ë„ê°€ 1.8ë¡œ ì¤„ì—ˆìœ¼ë¯€ë¡œ ì  ê¸°ë³¸ ì†ë„ ì†Œí­ ìƒí–¥)
        this.speed = gameSpeed + 1 + Math.random() * 2; // ê¸°ë³¸ +1 ì¶”ê°€
        
        if (this.type === 'tank') {
            this.width = 60; this.height = 60;
            this.speed = gameSpeed * 0.8 + 0.5; // íƒ±í¬ë„ ìµœì†Œ ì†ë„ ë³´ì¥
        } else if (this.type === 'speed') {
            this.speed = gameSpeed * 1.5 + 3; // ìŠ¤í”¼ë“œí˜•ì€ ë” ë¹ ë¥´ê²Œ
        }

        // ë­‰ì¹œ í¬ê¸°
        this.packSize = packSize;
        
        // ì²´ë ¥ ì„¤ì •
        const baseHp = 3;
        this.hp = hp ?? (baseHp * this.packSize * hpMultiplier);
        this.maxHp = this.hp; // ìµœëŒ€ ì²´ë ¥ (ë³´ìŠ¤ ë“± í‘œì‹œìš©)
        
        this.markedForDeletion = false;
        this.color = '#e74c3c';
        
        // ì§€ê·¸ì¬ê·¸ ì´ë™ì„ ìœ„í•œ ë³€ìˆ˜
        this.angle = 0; 
    }
    update() {
        this.y += this.speed;
        
        // íŒ¨í„´ ì´ë™
        if (this.type === 'zigzag') {
            this.x += Math.sin(this.angle) * 3;
            this.angle += 0.1;
            // í™”ë©´ ë°– ë‚˜ê°€ì§€ ì•Šê²Œ
            if(this.x < 0) this.x = 0;
            if(this.x > GAME_WIDTH - this.width) this.x = GAME_WIDTH - this.width;
        } else if (this.type === 'boss') {
             // ë³´ìŠ¤ ì›€ì§ì„ (ì²œì²œíˆ ë‚´ë ¤ì˜¤ë‹¤ê°€ ì¢Œìš°ë¡œ ì™”ë‹¤ê°”ë‹¤)
             if (this.y < 100) this.y += this.speed;
             else {
                 this.x += Math.sin(frameCount * 0.02) * 2;
             }
        }

        if (this.y > GAME_HEIGHT) this.markedForDeletion = true;
    }
    draw() {
        // ê²Œì´íŠ¸ì™€ ê²¹ì¹˜ëŠ”ì§€ í™•ì¸ (ë°˜íˆ¬ëª… ì²˜ë¦¬)
        let isOverlapping = false;
        for(const gate of gates) {
            if (this.x < gate.x + gate.width &&
                this.x + this.width > gate.x &&
                this.y < gate.y + gate.height &&
                this.y + this.height > gate.y) {
                isOverlapping = true;
                break;
            }
        }

        if (isOverlapping) ctx.globalAlpha = 0.3;

        // íƒ€ì…ë³„ ê·¸ë¦¬ê¸°
        if (this.type === 'tank') {
             // íƒ±í¬í˜•: í¬ê²Œ ê·¸ë¦¼
             if (enemyImg.complete && enemyImg.naturalWidth > 0) {
                ctx.drawImage(enemyImg, this.x, this.y, this.width, this.height);
            } else {
                ctx.fillStyle = '#c0392b'; // ë” ì§„í•œ ë¹¨ê°•
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
            // ì²´ë ¥ë°” í‘œì‹œ
            ctx.fillStyle = 'red';
            ctx.fillRect(this.x, this.y - 10, this.width, 5);
            ctx.fillStyle = '#2ecc71';
            ctx.fillRect(this.x, this.y - 10, this.width * (this.hp / this.maxHp), 5);

        } else if (this.packSize > 1) {
            // ë­‰ì¹œ ì  ê·¸ë¦¬ê¸° (ê¸°ì¡´ ë¡œì§)
            for(let i=0; i<this.packSize; i++) {
                const offsetX = (i % 2 === 0 ? 1 : -1) * (i * 5);
                const offsetY = (i * 5);
                if (enemyImg.complete && enemyImg.naturalWidth > 0) {
                    ctx.drawImage(enemyImg, this.x + offsetX, this.y - offsetY, this.width, this.height);
                } else {
                    ctx.fillStyle = this.color;
                    ctx.fillRect(this.x + offsetX, this.y - offsetY, this.width, this.height);
                }
            }
            ctx.fillStyle = 'white';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            const currentPackCount = Math.ceil(this.hp / 3);
            ctx.fillText(`x${currentPackCount}`, this.x + this.width/2, this.y - 10);

        } else {
            // ì¼ë°˜/ìŠ¤í”¼ë“œ/ì§€ê·¸ì¬ê·¸ ì 
            if (enemyImg.complete && enemyImg.naturalWidth > 0) {
                ctx.drawImage(enemyImg, this.x, this.y, this.width, this.height);
            } else {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
            // ìŠ¤í”¼ë“œí˜•ì€ ìƒ‰ìƒ ë‹¤ë¥´ê²Œ ë“± ì¶”ê°€ ê°€ëŠ¥
        }

        if (isOverlapping) ctx.globalAlpha = 1.0;
    }
}

class Gate {
    constructor(x, width, text, isCorrect, passed, y) {
        this.x = x;
        this.y = y ?? -150;
        this.width = width;
        this.height = 100;
        this.text = text;
        this.isCorrect = isCorrect;
        this.passed = passed ?? false;
        this.markedForDeletion = false;
    }
    update() {
        this.y += gameSpeed;
        if (this.y > GAME_HEIGHT) this.markedForDeletion = true;
    }
    draw() {
        ctx.fillStyle = 'rgba(52, 152, 219, 0.6)'; 
        ctx.fillRect(this.x + 5, this.y, this.width - 10, this.height);
        ctx.strokeStyle = '#2980b9';
        ctx.lineWidth = 3;
        ctx.strokeRect(this.x + 5, this.y, this.width - 10, this.height);

        // ë³´ê¸° í…ìŠ¤íŠ¸ (í°íŠ¸ í‚¤ìš°ê³  ì¤‘ì•™ ì •ë ¬)
        ctx.fillStyle = 'white';
        ctx.font = 'bold 20px Malgun Gothic';
        ctx.textAlign = 'center';
        // y ìœ„ì¹˜ ì¡°ì •: ?ê°€ ì—†ì–´ì¡Œìœ¼ë¯€ë¡œ ì¡°ê¸ˆ ë” ìœ„ë¡œ ì˜¬ë ¤ì„œ ì¤‘ì•™ì— ê°€ê¹ê²Œ ë°°ì¹˜
        wrapText(ctx, this.text, this.x + this.width/2, this.y + 45, this.width - 20, 24);
    }
}

// ì•„ì´í…œ í´ë˜ìŠ¤
class Item {
    constructor() {
        this.width = 40;
        this.height = 40;
        this.x = Math.random() * (GAME_WIDTH - this.width);
        this.y = -50;
        this.speed = gameSpeed;
        this.markedForDeletion = false;
        
        // íƒ€ì… ëœë¤ ê²°ì •
        const rand = Math.random();
        if (rand < 0.3) this.type = 'shield'; // 30%
        else if (rand < 0.6) this.type = 'fever'; // 30%
        else if (rand < 0.8) this.type = 'bomb'; // 20%
        else this.type = 'plus'; // 20%
    }
    update() {
        this.y += this.speed;
        if (this.y > GAME_HEIGHT) this.markedForDeletion = true;
    }
    draw() {
        // ì•„ì´í…œ ë°•ìŠ¤ ê·¸ë¦¬ê¸° (ì´ë¯¸ì§€ ë˜ëŠ” ì´ëª¨ì§€ ì‚¬ìš©)
        
        if (this.type === 'bomb') {
            // í­íƒ„: ë¹¨ê°„ìƒ‰ ì‚¬ê°í˜• ì•ˆì— bomb.png ì´ë¯¸ì§€
            ctx.fillStyle = '#e74c3c'; // ë¹¨ê°„ìƒ‰ ë°°ê²½
            ctx.fillRect(this.x, this.y, this.width, this.height);
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.strokeRect(this.x, this.y, this.width, this.height);

            if (itemImgs.bomb.complete && itemImgs.bomb.naturalWidth > 0) {
                // ì´ë¯¸ì§€ ì—¬ë°±ì„ ì¡°ê¸ˆ ì£¼ì–´ ì‚¬ê°í˜• ì•ˆì— ì™ ë“¤ì–´ê°€ê²Œ ê·¸ë¦¼
                const padding = 5;
                ctx.drawImage(itemImgs.bomb, this.x + padding, this.y + padding, this.width - padding*2, this.height - padding*2);
            } else {
                // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸
                ctx.fillStyle = 'white';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText("B", this.x + this.width/2, this.y + 27);
            }
        } else if (this.type === 'fever') {
            // í”¼ë²„ ì´ë¯¸ì§€ (ì •ì‚¬ê°í˜• ì—†ì´ ì´ë¯¸ì§€ ìì²´ë§Œ)
            // í”¼ë²„ ì´ë¯¸ì§€ëŠ” ë³´í†µ í™”ë ¤í•˜ë¯€ë¡œ ì•½ê°„ ë” í¬ê²Œ ê·¸ë ¤ë„ ë¨
            const size = this.width * 1.2;
            const offset = (size - this.width) / 2;
            
            if (itemImgs.fever.complete && itemImgs.fever.naturalWidth > 0) {
                ctx.drawImage(itemImgs.fever, this.x - offset, this.y - offset, size, size);
            } else {
                ctx.fillStyle = '#f39c12';
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.fillStyle = 'white';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText("F", this.x + this.width/2, this.y + 27);
            }
        } else if (this.type === 'shield') {
            // ë°©íŒ¨: ì‚¬ê°í˜• ì•ˆì— ì´ëª¨ì§€ ğŸ›¡ï¸
            ctx.fillStyle = '#3498db'; // íŒŒë€ìƒ‰ ë°°ê²½
            ctx.fillRect(this.x, this.y, this.width, this.height);
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.strokeRect(this.x, this.y, this.width, this.height);
            
            ctx.font = '24px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText("ğŸ›¡ï¸", this.x + this.width/2, this.y + this.height/2);
            ctx.textBaseline = 'alphabetic'; // ë³µêµ¬
        } else if (this.type === 'plus') {
            // í”ŒëŸ¬ìŠ¤: ì´ˆë¡ìƒ‰ ì‚¬ê°í˜• ì•ˆì— ìš°ì£¼ì„  + ê¸°í˜¸
            ctx.fillStyle = '#2ecc71'; // ì´ˆë¡ìƒ‰ ë°°ê²½
            ctx.fillRect(this.x, this.y, this.width, this.height);
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.strokeRect(this.x, this.y, this.width, this.height);
            
            // ìš°ì£¼ì„  ì´ë¯¸ì§€ (ì™¼ìª½)
            if (playerImg.complete && playerImg.naturalWidth > 0) {
                const shipSize = 24;
                ctx.drawImage(playerImg, this.x + 3, this.y + 8, shipSize, shipSize);
            }
            
            // + ê¸°í˜¸ (ì˜¤ë¥¸ìª½)
            ctx.fillStyle = 'white';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'left';
            ctx.fillText("+", this.x + 26, this.y + 27);
        }
    }
}

function spawnItem() {
    // ì•„ì´í…œ ìƒì„± í™•ë¥  ëŒ€í­ í•˜í–¥ (0.5% -> 0.1%)
    // ì•½ 15~20ì´ˆì— í•˜ë‚˜ ì •ë„ ë‚˜ì˜¤ë„ë¡ ì¡°ì •
    if (Math.random() < 0.001) {
        items.push(new Item());
    }
}

function applyItemEffect(type) {
    if (type === 'shield') {
        shieldActive = true;
        shieldTimer = 300; // 5ì´ˆ (60fps ê¸°ì¤€)
        createFloatingText("SHIELD!", player.x, player.y, "cyan");
    } else if (type === 'fever') {
        feverActive = true;
        feverTimer = 300; // 5ì´ˆ
        createFloatingText("FEVER!!", player.x, player.y, "orange");
    } else if (type === 'plus') {
        player.soldiers += 10;
        createFloatingText("+10", player.x, player.y, "#2ecc71");
    } else if (type === 'bomb') {
        // í™”ë©´ ë‚´ ëª¨ë“  ì  ì œê±°
        enemies.forEach(e => {
            e.markedForDeletion = true;
            score += 10;
            // í­ë°œ íš¨ê³¼
            for(let i=0; i<10; i++) particles.push(new Particle(e.x, e.y, '#e74c3c'));
        });
        createFloatingText("BOOM!", player.x, player.y, "red");
        playSound('bomb'); // í­ë°œìŒ ì¬ìƒ
    }
}

// ì  ì´ì•Œ í´ë˜ìŠ¤ ì¶”ê°€
class EnemyBullet {
    constructor(x, y, angle, speed, type = 'normal') {
        this.x = x;
        this.y = y;
        this.angle = angle;
        this.speed = speed;
        this.type = type; // normal, laser
        this.radius = type === 'laser' ? 10 : 6;
        this.markedForDeletion = false;
        this.color = type === 'laser' ? '#e74c3c' : '#9b59b6'; // ë ˆì´ì €ëŠ” ë¹¨ê°•, ì¼ë°˜íƒ„ì€ ë³´ë¼
    }
    update() {
        this.x += Math.cos(this.angle) * this.speed;
        this.y += Math.sin(this.angle) * this.speed;
        
        if (this.x < 0 || this.x > GAME_WIDTH || this.y > GAME_HEIGHT || this.y < 0) {
            this.markedForDeletion = true;
        }
    }
    draw() {
        ctx.fillStyle = this.color;
        ctx.beginPath();
        if (this.type === 'laser') {
            // ë ˆì´ì €ëŠ” ê¸¸ì­‰í•˜ê²Œ
            ctx.ellipse(this.x, this.y, 15, 5, this.angle, 0, Math.PI*2);
        } else {
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
        }
        ctx.fill();
    }
}

// ë³´ìŠ¤ í´ë˜ìŠ¤ ìˆ˜ì •
class Boss {
    constructor() {
        this.width = 150;
        this.height = 120;
        this.x = GAME_WIDTH / 2 - this.width / 2;
        this.y = -150;
        
        // ë³´ìŠ¤ ë ˆë²¨ (ë“±ì¥ íšŸìˆ˜ì— ë”°ë¼ ë‚œì´ë„ ì¦ê°€)
        this.level = Math.floor(score / 2000) + 1;
        
        this.hp = 100 + (this.level * 50); // ë ˆë²¨ë‹¹ ì²´ë ¥ 50 ì¦ê°€
        this.maxHp = this.hp;
        this.markedForDeletion = false;
        this.angle = 0;
        this.attackTimer = 0;
        this.isDashing = false; // ëŒì§„ ìƒíƒœ
        this.dashTargetY = 0;

        // ë³´ìŠ¤ ì´ë¯¸ì§€ ëœë¤ ì„ íƒ (boss1~4 ë˜ëŠ” alien)
        const rand = Math.floor(Math.random() * 5); // 0~4
        if (rand < 4) {
            this.image = bossImgs[rand];
        } else {
            this.image = enemyImg; // ê¸°ì¡´ alien.png (í™•ëŒ€ë¨)
        }
    }
    update() {
        // ëŒì§„ íŒ¨í„´ ì²˜ë¦¬
        if (this.isDashing) {
            this.y += 15; // ë¹ ë¥´ê²Œ í•˜ê°•
            if (this.y > GAME_HEIGHT) {
                // í™”ë©´ ì•„ë˜ë¡œ ë‚˜ê°€ë©´ ìœ„ë¡œ ë³µê·€
                this.y = -200;
                this.isDashing = false;
            }
            return; // ëŒì§„ ì¤‘ì—ëŠ” ë‹¤ë¥¸ ì›€ì§ì„/ê³µê²© ì•ˆí•¨
        }

        // ë“±ì¥ ì—°ì¶œ
        if (this.y < 80) this.y += 2;
        else {
            // ì¢Œìš° ì´ë™ íŒ¨í„´ (ë ˆë²¨ ë†’ì„ìˆ˜ë¡ ë¹ ë¦„)
            const moveSpeed = 0.02 + (this.level * 0.005);
            this.x += Math.sin(frameCount * moveSpeed) * (2 + this.level);
            
            // í™”ë©´ ë°– ì œí•œ
            if(this.x < 0) this.x = 0;
            if(this.x > GAME_WIDTH - this.width) this.x = GAME_WIDTH - this.width;
        }
        
        // ë³´ìŠ¤ ê³µê²© íŒ¨í„´
        this.attackTimer++;
        
        // ë ˆë²¨ì— ë”°ë¥¸ ê³µê²© ì£¼ê¸° ë‹¨ì¶• (ê¸°ë³¸ 60í”„ë ˆì„ -> ë ˆë²¨ë‹¹ 5í”„ë ˆì„ ê°ì†Œ)
        const attackInterval = Math.max(30, 80 - (this.level * 5));
        
        if (this.attackTimer > attackInterval) {
            this.attackTimer = 0;
            this.attack();
        }
    }
    
    attack() {
        const centerX = this.x + this.width/2;
        const centerY = this.y + this.height;
        
        // íŒ¨í„´ 1: ì¡°ì¤€ ì‚¬ê²© (í”Œë ˆì´ì–´ ë°©í–¥)
        const dx = (player.x + player.width/2) - centerX;
        const dy = (player.y + player.height/2) - centerY;
        const targetAngle = Math.atan2(dy, dx);
        
        // ê¸°ë³¸íƒ„ ë°œì‚¬
        enemies.push(new EnemyBullet(centerX, centerY, targetAngle, 5));
        
        // ë ˆë²¨ 2 ì´ìƒ: ë¶€ì±„ê¼´ ì‚°íƒ„ (3ë°œ)
        if (this.level >= 2) {
            enemies.push(new EnemyBullet(centerX, centerY, targetAngle - 0.3, 5));
            enemies.push(new EnemyBullet(centerX, centerY, targetAngle + 0.3, 5));
        }
        
        // ë ˆë²¨ 3 ì´ìƒ: ì›í˜• íƒ„ë§‰ íŒ¨í„´ (ê°€ë” ë°œë™)
        if (this.level >= 3 && Math.random() < 0.3) {
            for(let i=0; i<8; i++) {
                const angle = (Math.PI * 2 / 8) * i;
                enemies.push(new EnemyBullet(centerX, centerY, angle, 4));
            }
        }
        
        // ë ˆë²¨ 4 ì´ìƒ: ëª¸í†µ ë°•ì¹˜ê¸° (ëŒì§„)
        if (this.level >= 4 && Math.random() < 0.2) {
             this.isDashing = true;
             createFloatingText("DASH!", this.x + this.width/2, this.y, "red");
        }
        
        // ë ˆë²¨ 5 ì´ìƒ: ê³ ì† ë ˆì´ì € (ë¹ ë¥¸ íƒ„ì†)
        if (this.level >= 5 && Math.random() < 0.4) {
             enemies.push(new EnemyBullet(centerX, centerY, targetAngle, 12, 'laser'));
        }
    }

    draw() {
        // ë³´ìŠ¤ ì™¸í˜• ê·¸ë¦¬ê¸°
        if (this.image && this.image.complete && this.image.naturalWidth > 0) {
            ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
        } else {
            ctx.fillStyle = 'purple';
            ctx.fillRect(this.x, this.y, this.width, this.height);
        }
        
        // ë³´ìŠ¤ ì²´ë ¥ë°”
        ctx.fillStyle = 'black';
        ctx.fillRect(this.x, this.y - 20, this.width, 10);
        ctx.fillStyle = 'red';
        ctx.fillRect(this.x, this.y - 20, this.width * (this.hp / this.maxHp), 10);
        ctx.strokeStyle = 'white';
        ctx.strokeRect(this.x, this.y - 20, this.width, 10);
        
        // ë ˆë²¨ í‘œì‹œ
        ctx.fillStyle = 'white';
        ctx.font = 'bold 16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(`Lv.${this.level}`, this.x + this.width/2, this.y - 25);
    }
}

function spawnBoss() {
    boss = new Boss();
    // ë ˆë²¨ 3 ì´ìƒë¶€í„°ëŠ” ë³´ìŠ¤ì „ ì§‘ì¤‘ ëª¨ë“œ (ìŠ¤í¬ë¡¤ ì •ì§€, ì¡ëª¹ ì œê±°)
    if (boss.level >= 3) {
        isBossBattleMode = true;
        gates = []; // ê²Œì´íŠ¸ ì œê±°
        enemies = []; // ì¡ëª¹ ì œê±°
        createFloatingText("âš ï¸ HIGH LEVEL BOSS! âš ï¸", GAME_WIDTH/2, 200, "red");
        createFloatingText("MOVEMENT STOPPED!", GAME_WIDTH/2, 250, "red");
    } else {
        createFloatingText("WARNING: BOSS!", GAME_WIDTH/2 - 50, 200, "red");
    }
}

// í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ (ìˆ˜ì •: ìƒë‹¨ ë¬¸ì œ í‘œì‹œì¤„ì—ë„ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ ì¡°ì •)
function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
    let words = text.split(' ');
    let line = '';
    
    // ë§Œì•½ ë‹¨ì–´ í•˜ë‚˜ê°€ ë„ˆë¬´ ê¸¸ë©´(ì˜ì–´ ë“±) ì˜ë¦¬ëŠ” ë¬¸ì œ ë°©ì§€
    // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ê³µë°± ê¸°ì¤€ ë¶„ë¦¬ë§Œ ì²˜ë¦¬
    
    for(let n = 0; n < words.length; n++) {
        let testLine = line + words[n] + ' ';
        let metrics = ctx.measureText(testLine);
        if (metrics.width > maxWidth && n > 0) {
            ctx.fillText(line, x, y);
            line = words[n] + ' ';
            y += lineHeight;
        } else {
            line = testLine;
        }
    }
    ctx.fillText(line, x, y);
}

class Particle {
    constructor(x, y, color) {
        this.x = x; this.y = y; this.color = color;
        this.size = Math.random() * 5 + 2;
        this.speedX = Math.random() * 6 - 3;
        this.speedY = Math.random() * 6 - 3;
        this.life = 100;
    }
    update() { this.x += this.speedX; this.y += this.speedY; this.life -= 2; }
    draw() {
        ctx.globalAlpha = this.life / 100;
        ctx.fillStyle = this.color;
        ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1.0;
    }
}

function createFloatingText(text, x, y, color) {
    floatingTexts.push({text, x, y, color, life: 60});
}

/**
 * 5. ê²Œì„ ë¡œì§
 */
function spawnGateRow() {
    const qIndex = Math.floor(Math.random() * QUESTIONS.length);
    const qData = QUESTIONS[qIndex];
    currentQuestionObj = qData;

    const gateWidth = GAME_WIDTH / 3;
    
    // ë³´ê¸° ìƒì„± ë° ì…”í”Œ (ì •ë‹µ 1ê°œ + ì˜¤ë‹µ 2ê°œ)
    let options = [];
    options.push({ text: qData.a, isCorrect: true });
    
    // ì˜¤ë‹µ ë¦¬ìŠ¤íŠ¸ ì…”í”Œ í›„ 2ê°œ ì„ íƒ
    let wrongPool = shuffle([...qData.w]);
    options.push({ text: wrongPool[0] || "ì˜¤ë‹µ", isCorrect: false });
    options.push({ text: wrongPool[1] || wrongPool[0] || "ì˜¤ë‹µ", isCorrect: false }); // ì˜¤ë‹µ ë¶€ì¡±ì‹œ ì¤‘ë³µ ì²˜ë¦¬

    // ìµœì¢… ë°°ì¹˜ ì…”í”Œ
    options = shuffle(options);

    for(let i=0; i<3; i++) {
        gates.push(new Gate(i * gateWidth, gateWidth, options[i].text, options[i].isCorrect));
    }
}

function spawnEnemy() {
    // ì  ìƒì„± í™•ë¥  ì¡°ì • (ë„ˆë¬´ ë§ì´ ë‚˜ì˜¤ì§€ ì•Šê²Œ ì œí•œ)
    // ê¸°ì¡´: 0.02 + ì‹œê°„ ë¹„ë¡€ -> ìˆ˜ì •: ìµœëŒ€ 0.03ìœ¼ë¡œ ì œí•œ
    const spawnChance = Math.min(0.03, 0.01 + (frameCount * 0.000005));
    
    if (Math.random() < spawnChance) {
        let packSize = 1;
        let hpMultiplier = 1;
        let type = 'normal';

        // ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ê°•ë ¥í•œ ì (ì²´ë ¥ ë†’ìŒ) ë“±ì¥ í™•ë¥  ì¦ê°€
        if (frameCount > 500) {
            const rand = Math.random();
            if (rand < 0.2) {
                // íƒ±ì»¤í˜• ì  (ì²´ë ¥ 5ë°°, í¬ê¸° í¼)
                type = 'tank';
                hpMultiplier = 5;
                packSize = 1; // ë‹¨ì¼ ê°œì²´ì§€ë§Œ ê°•ë ¥í•¨
            } else if (rand < 0.4) {
                // ìŠ¤í”¼ë“œí˜• ì  (ì²´ë ¥ ë‚®ìŒ, ë¹ ë¦„)
                type = 'speed';
                hpMultiplier = 0.5;
            } else if (rand < 0.6) {
                 // ì§€ê·¸ì¬ê·¸ ì´ë™ ì 
                 type = 'zigzag';
                 hpMultiplier = 1.5;
            } else if (frameCount > 1000 && rand < 0.7) {
                // ë­‰ì¹œ ì  (ê¸°ì¡´ ë¡œì§ ìœ ì§€í•˜ë˜ í™•ë¥  ë‚®ì¶¤)
                packSize = Math.floor(Math.random() * 3) + 2; 
                type = 'pack';
            }
        }
        
        enemies.push(new Enemy(null, null, null, packSize, type, hpMultiplier));
    }
}

function checkCollisions() {
    // ì´ì•Œ vs ì 
    bullets.forEach(bullet => {
        enemies.forEach(enemy => {
            // ì  ì´ì•Œ(ë¶„í™ìƒ‰)ê³¼ëŠ” ì•„êµ° ì´ì•Œì´ ë¶€ë”ªíˆì§€ ì•Šê²Œ (ìƒì‡„ íš¨ê³¼ ì œê±°)
            if (enemy instanceof EnemyBullet) return;

            const dist = Math.hypot(bullet.x - (enemy.x + 20), bullet.y - (enemy.y + 20));
            if (dist < 20 + bullet.radius) {
                enemy.hp--;
                bullet.markedForDeletion = true;
                for(let i=0; i<3; i++) particles.push(new Particle(bullet.x, bullet.y, '#f1c40f'));
                if (enemy.hp <= 0) {
                    enemy.markedForDeletion = true;
                    score += 10;
                    for(let i=0; i<10; i++) particles.push(new Particle(enemy.x+20, enemy.y+20, '#e74c3c'));
                }
            }
        });
    });

    // í”Œë ˆì´ì–´ vs ì  (ë° ì  ì´ì•Œ)
    enemies.forEach(enemy => {
        if (!enemy.markedForDeletion) {
            
            // ì  ì´ì•Œì¸ì§€ í™•ì¸ (EnemyBullet ì¸ìŠ¤í„´ìŠ¤ ì²´í¬)
            const isBullet = enemy instanceof EnemyBullet;
            
            let collision = false;
            
            if (isBullet) {
                // ì´ì•Œ ì¶©ëŒ íŒì • (ì›í˜•)
                const dist = Math.hypot(player.x + player.width/2 - enemy.x, player.y + player.height/2 - enemy.y);
                if (dist < (player.width/2 + enemy.radius)) {
                    collision = true;
                    // ì  ì´ì•Œê³¼ ì¶©ëŒ ì‹œ ì´í™íŠ¸ ì œê±° (ì‹œì•¼ ë°©í•´ ë°©ì§€)
                    // createFloatingText("HIT!", player.x, player.y, "orange"); 
                }
            } else {
                // ì¼ë°˜ ì  ì¶©ëŒ íŒì • (ì‚¬ê°í˜•)
                if (player.x < enemy.x + enemy.width && player.x + player.width > enemy.x &&
                    player.y < enemy.y + enemy.height && player.y + player.height > enemy.y) {
                    collision = true;
                }
            }

            if (collision) {
                // ë³´í˜¸ë§‰ ìˆìœ¼ë©´ í”¼í•´ ì—†ìŒ
                if (shieldActive) {
                    enemy.markedForDeletion = true;
                    createFloatingText("Shield!", player.x, player.y, "cyan");
                } else {
                    let damage = 0;
                    const currentLevel = Math.floor(score / 2000) + 1; // ë‚œì´ë„ ë ˆë²¨

                    if (isBullet) {
                        // ì´ì•Œ ë°ë¯¸ì§€ (ê¸°ë³¸ ë°ë¯¸ì§€ ëŒ€í­ ìƒí–¥)
                        // ì¼ë°˜íƒ„: 30, ë ˆì´ì €: 100
                        let baseDamage = enemy.type === 'laser' ? 100 : 30; 
                        
                        // Lv 6 ì´ìƒ(ì ìˆ˜ 10000ì  ì´ìƒ)ë¶€í„°ëŠ” ë¹„ìœ¨ ë°ë¯¸ì§€ ì ìš©
                        if (currentLevel > 5) {
                            // ì¼ë°˜íƒ„ 10%, ë ˆì´ì € 30% (ë§¤ìš° ì•„í””)
                            const ratio = enemy.type === 'laser' ? 0.3 : 0.1;
                            damage = Math.max(baseDamage, Math.floor(player.soldiers * ratio));
                        } else {
                            damage = baseDamage;
                        }
                    } else {
                        // ëª¸í†µ ë°•ì¹˜ê¸° ë°ë¯¸ì§€
                        const currentPackCount = Math.ceil(enemy.hp / 3) || 1;
                        // ê¸°ë³¸ ë°ë¯¸ì§€ ìƒí–¥: ë§ˆë¦¬ë‹¹ 5 -> 10
                        let baseDamage = 10 * currentPackCount;
                        
                        if (currentLevel > 5) {
                            // ì¶©ëŒì€ ë§¤ìš° ì¹˜ëª…ì : ê¸°ë³¸ 20% * ë­‰ì¹œ ìˆ˜
                            const ratio = 0.2 * currentPackCount;
                            damage = Math.max(baseDamage, Math.floor(player.soldiers * ratio));
                        } else {
                            damage = baseDamage;
                        }
                    }
                    
                    player.soldiers -= damage;
                    enemy.markedForDeletion = true;
                    createFloatingText(`-${damage}`, player.x, player.y, "red");
                    updateHUD();
                    ctx.translate(5, 0); setTimeout(() => ctx.translate(-5, 0), 50);
                }
            }
        }
    });

    // í”Œë ˆì´ì–´ vs ê²Œì´íŠ¸
    gates.forEach(gate => {
        if (!gate.passed &&
            player.x < gate.x + gate.width && player.x + player.width > gate.x &&
            player.y < gate.y + gate.height && player.y + player.height > gate.y) {
            
            gate.passed = true;
            
            if (gate.isCorrect) {
                player.soldiers *= 2;
                totalCorrect++;
                consecutiveCorrect++;
                if(consecutiveCorrect > maxCombo) maxCombo = consecutiveCorrect;

                createFloatingText("ì •ë‹µ!", player.x, player.y - 50, "#2ecc71");
                score += 100;
                playSound('correct'); // ì •ë‹µ íš¨ê³¼ìŒ
                
                // ì½¤ë³´ íš¨ê³¼
                const comboElem = document.getElementById('hud-combo');
                comboElem.classList.remove('combo-active');
                void comboElem.offsetWidth; // trigger reflow
                comboElem.classList.add('combo-active');

            } else {
                player.soldiers = Math.floor(player.soldiers / 2);
                consecutiveCorrect = 0;
                totalWrong++; // ì˜¤ë‹µ ì¹´ìš´íŠ¸
                createFloatingText("í‹€ë ¸ì–´!", player.x, player.y - 50, "#e74c3c");
                playSound('wrong'); // ì˜¤ë‹µ íš¨ê³¼ìŒ
            }

            gates.forEach(g => { if (Math.abs(g.y - gate.y) < 10) g.passed = true; });
            currentQuestionObj = null;
            updateHUD();
        }
    });
}

function updateHUD() {
    document.getElementById('hud-score').innerText = Math.floor(score);
    document.getElementById('hud-total').innerText = totalCorrect;
    document.getElementById('hud-combo').innerText = `Combo: ${consecutiveCorrect}`;
}

function updateHUDStats() {
    // ìµœê³  ê¸°ë¡
    document.getElementById('hud-best-score').innerText = Math.floor(globalStats.bestScore);
    document.getElementById('hud-best-combo').innerText = globalStats.bestMaxCombo;
    document.getElementById('hud-best-correct').innerText = globalStats.bestCorrect;

    // ëˆ„ì  í†µê³„
    document.getElementById('hud-life-correct').innerText = globalStats.lifetimeCorrect;
    
    let acc = 0;
    if (globalStats.lifetimeAttempts > 0) {
        acc = Math.floor((globalStats.lifetimeCorrect / globalStats.lifetimeAttempts) * 100);
    }
    document.getElementById('hud-life-acc').innerText = acc + "%";
}

function drawRoad() {
    ctx.fillStyle = '#34495e';
    ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
    ctx.lineWidth = 4;
    ctx.setLineDash([20, 20]);
    
    // ë³´ìŠ¤ì „ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ìŠ¤í¬ë¡¤ ì§„í–‰
    if (!isBossBattleMode) {
        scrollOffset += gameSpeed;
    }
    const lineOffset = scrollOffset % 40;
    
    ctx.beginPath(); ctx.moveTo(GAME_WIDTH/3, -40+lineOffset); ctx.lineTo(GAME_WIDTH/3, GAME_HEIGHT); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(GAME_WIDTH*2/3, -40+lineOffset); ctx.lineTo(GAME_WIDTH*2/3, GAME_HEIGHT); ctx.stroke();
    ctx.setLineDash([]);
}

function drawUI() {
    // ìƒë‹¨ ë¬¸ì œ í‘œì‹œì¤„
    const uiHeight = 80;
    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
    ctx.fillRect(0, 0, GAME_WIDTH, uiHeight);
    
    ctx.fillStyle = 'white'; 
    ctx.textAlign = 'center';
    
    if (currentQuestionObj) {
        ctx.font = 'bold 18px Malgun Gothic'; 
        ctx.fillStyle = '#f39c12';
        
        // ë¬¸ì œ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ì²˜ë¦¬ (yì¢Œí‘œ 30ë¶€í„° ì‹œì‘, ì¤„ê°„ê²© 24)
        wrapText(ctx, "Q. " + currentQuestionObj.q, GAME_WIDTH/2, 30, GAME_WIDTH - 40, 24);
        
        // íŒíŠ¸ ë©”ì‹œì§€ (ë¬¸ì œ í…ìŠ¤íŠ¸ê°€ ê¸¸ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í•˜ë‹¨ì— ê³ ì •í•˜ì§€ ì•Šê³  ìƒí™©ì— ë”°ë¼ ìœ„ì¹˜ ì¡°ì • ê°€ëŠ¥í•˜ë‚˜, ì¼ë‹¨ ê³ ì •)
        // ë§Œì•½ ë¬¸ì œê°€ ë„ˆë¬´ ê¸¸ë©´ ê²¹ì¹  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ í•˜ë‹¨ì— ë¶™ì—¬ì„œ ì¶œë ¥
        // ctx.font = '14px Malgun Gothic'; 
        // ctx.fillStyle = '#bdc3c7';
        // ctx.fillText("ì•Œë§ì€ ë³´ê¸°ë¥¼ ì°¾ì•„ ì´ë™í•˜ì„¸ìš”!", GAME_WIDTH/2, 70); 
    } else {
        ctx.font = 'bold 20px Malgun Gothic';
        ctx.fillText("ë‹¤ìŒ ë¬¸ì œ ì¤€ë¹„ ì¤‘...", GAME_WIDTH/2, 50);
    }
}

function animate() {
    if (gameState !== 'PLAYING') return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawRoad();

    player.x += (targetX - player.x) * 0.1;
    if (player.x < 0) player.x = 0;
    if (player.x > GAME_WIDTH - player.width) player.x = GAME_WIDTH - player.width;

    if (frameCount > nextGateFrame && !gates.some(g => g.y < GAME_HEIGHT && g.y > 0)) {
        if (!isBossBattleMode) { // ë³´ìŠ¤ì „ ëª¨ë“œ ì•„ë‹ ë•Œë§Œ ìƒì„±
            spawnGateRow();
            // ì†ë„ê°€ ëŠë ¤ì¡Œìœ¼ë¯€ë¡œ ê²Œì´íŠ¸ ê°„ê²©ì„ ì¡°ê¸ˆ ë” ë„“í˜ (400 -> 450)
            nextGateFrame = frameCount + 450;
        }
    }
    
    if (!isBossBattleMode) { // ë³´ìŠ¤ì „ ëª¨ë“œ ì•„ë‹ ë•Œë§Œ ì¡ëª¹ ìƒì„±
        spawnEnemy();
    }
    
    // ì•„ì´í…œ ìƒì„±
    spawnItem();
    
    // ë³´ìŠ¤ ë“±ì¥ ì²´í¬
    if (!boss && score >= bossSpawnScore) {
        spawnBoss();
        bossSpawnScore += 2000; // ë‹¤ìŒ ë³´ìŠ¤ëŠ” 2000ì  ë’¤ì—
    }

    // 4. ì—…ë°ì´íŠ¸ ë° ê·¸ë¦¬ê¸°
    
    // ì•„ì´í…œ
    items.forEach(item => { item.update(); item.draw(); });
    items = items.filter(item => !item.markedForDeletion);

    // ë³´ìŠ¤
    if (boss) {
        boss.update();
        boss.draw();
        if (boss.markedForDeletion) boss = null;
    }

    gates.forEach(g => { g.update(); g.draw(); });
    gates = gates.filter(g => !g.markedForDeletion);

    enemies.forEach(e => { e.update(); e.draw(); });
    enemies = enemies.filter(e => !e.markedForDeletion);

    player.update();
    player.draw();

    bullets.forEach(b => { b.update(); b.draw(); });
    bullets = bullets.filter(b => !b.markedForDeletion);

    particles.forEach(p => { p.update(); p.draw(); });
    particles = particles.filter(p => p.life > 0);

    floatingTexts.forEach((ft, idx) => {
        ft.y -= 1; ft.life--;
        ctx.globalAlpha = ft.life/60; ctx.fillStyle = ft.color;
        ctx.font = 'bold 20px Arial'; ctx.textAlign = 'center';
        ctx.fillText(ft.text, ft.x, ft.y);
        ctx.globalAlpha = 1.0;
        if(ft.life <= 0) floatingTexts.splice(idx, 1);
    });

    checkCollisions();
    
    // ì•„ì´í…œ íšë“ ì²´í¬
    items.forEach(item => {
        if (!item.markedForDeletion && 
            player.x < item.x + item.width && player.x + player.width > item.x &&
            player.y < item.y + item.height && player.y + player.height > item.y) {
            
            item.markedForDeletion = true;
            applyItemEffect(item.type);
        }
    });

    // ë³´ìŠ¤ ì¶©ëŒ ì²´í¬
    if (boss) {
        // ì´ì•Œ vs ë³´ìŠ¤
        bullets.forEach(bullet => {
            if (bullet.x > boss.x && bullet.x < boss.x + boss.width &&
                bullet.y > boss.y && bullet.y < boss.y + boss.height) {
                
                boss.hp--;
                bullet.markedForDeletion = true;
                // ë³´ìŠ¤ í”¼ê²© ì´í™íŠ¸ (ë³µêµ¬)
                for(let i=0; i<5; i++) particles.push(new Particle(bullet.x, bullet.y, '#f1c40f'));
                
                if (boss.hp <= 0) {
                    boss.markedForDeletion = true;
                    isBossBattleMode = false; // ë³´ìŠ¤ì „ ëª¨ë“œ í•´ì œ (ì´ë™ ì¬ê°œ)
                    score += 500; // ë³´ìŠ¤ ì²˜ì¹˜ ì ìˆ˜
                    createFloatingText("BOSS CLEARED!", boss.x + boss.width/2, boss.y, "#f1c40f");
                    // ëŒ€ëŸ‰ í­ë°œ íš¨ê³¼
                    for(let i=0; i<50; i++) particles.push(new Particle(boss.x + Math.random()*boss.width, boss.y + Math.random()*boss.height, '#e74c3c'));
                }
            }
        });

        // í”Œë ˆì´ì–´ vs ë³´ìŠ¤ (ì¶©ëŒ ì‹œ í° í”¼í•´)
        if (!boss.markedForDeletion && 
            player.x < boss.x + boss.width && player.x + player.width > boss.x &&
            player.y < boss.y + boss.height && player.y + player.height > boss.y) {
            
            if (!shieldActive) {
                // ë³´ìŠ¤ ëª¸í†µ ë°•ì¹˜ê¸° ë°ë¯¸ì§€ ê³„ì‚°
                let damage = 0;
                const currentLevel = Math.floor(score / 2000) + 1;

                if (boss.isDashing) {
                    // ëŒì§„ ì¤‘ì¼ ë•ŒëŠ” í° í”¼í•´ (í•œ ë²ˆì— ì¾…!)
                    if (currentLevel > 5) {
                        // ê³ ë ˆë²¨: ë³‘ì‚¬ì˜ 50% ì¦‰ì‹œ ì‚­ì œ (ì ˆë°˜ì´ ë‚ ì•„ê°)
                        damage = Math.max(300, Math.floor(player.soldiers * 0.5));
                    } else {
                        // ì €ë ˆë²¨: 300ëª… ê°ì†Œ
                        damage = 300;
                    }
                    
                    // í”Œë ˆì´ì–´ ë„‰ë°±
                    ctx.translate(10, 10); setTimeout(() => ctx.translate(-10, -10), 50);
                    createFloatingText("CRITICAL!", player.x, player.y, "red");
                    
                    player.soldiers -= damage; 
                    createFloatingText(`-${damage}`, player.x, player.y, "red");
                } 
                // ì¼ë°˜ ì ‘ì´‰(ë¹„ë¹„ê¸°) ì½”ë“œëŠ” ì œê±°ë¨ (ë°ë¯¸ì§€ ì—†ìŒ)
            }
        }
    }

    drawUI();
    
    // ì ìˆ˜ ì¦ê°€ (ìƒì¡´ ì ìˆ˜)
    score += 0.1;
    if(frameCount % 10 === 0) updateHUD(); // HUD ì—…ë°ì´íŠ¸

    // [ì¶”ê°€] ì†ë„ ì ì§„ì  ì¦ê°€ (ìµœëŒ€ 1.8ê¹Œì§€)
    if (!isBossBattleMode && gameSpeed < 1.8) {
        gameSpeed += 0.0002; 
    }

    frameCount++;
    requestAnimationFrame(animate);
}

/**
 * 6. ì œì–´ ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
 */
// ë§ˆìš°ìŠ¤/í„°ì¹˜ ì…ë ¥
function handleInput(e) {
    if (gameState !== 'PLAYING') return;
    let clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    targetX = (clientX - rect.left) * scaleX - 20;
}
window.addEventListener('mousemove', handleInput);
window.addEventListener('touchmove', handleInput, {passive: false});
window.addEventListener('keydown', (e) => {
    if (gameState !== 'PLAYING') return;
    if (e.key === 'ArrowLeft') targetX -= 30;
    if (e.key === 'ArrowRight') targetX += 30;
});

// ì‹œì‘/ì¢…ë£Œ í•¨ìˆ˜
function startNewGame() {
    const nick = document.getElementById('nickname-input').value.trim();
    if(!nick) { alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
    
    // ë‹‰ë„¤ì„ ë³€ê²½ ì²´í¬
    const storedNick = localStorage.getItem(CURRENT_NICKNAME_KEY);
    if (storedNick && storedNick !== nick) {
        const confirmChange = confirm(`ë‹‰ë„¤ì„ì„ '${storedNick}'ì—ì„œ '${nick}'(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì£¼ì˜: ë‹‰ë„¤ì„ ë³€ê²½ ì‹œ ìµœê³  ê¸°ë¡, ëˆ„ì  í†µê³„ ë“± ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.`);
        if (!confirmChange) return; // ì·¨ì†Œ ì‹œ ê²Œì„ ì‹œì‘ ì•ˆ í•¨
        
        // ë°ì´í„° ì´ˆê¸°í™”
        localStorage.removeItem(SAVE_KEY);
        localStorage.removeItem(RECORD_KEY);
        localStorage.removeItem(STATS_KEY);
        
        // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
        globalStats = {
            bestScore: 0, bestCorrect: 0, bestMaxCombo: 0,
            lifetimeCorrect: 0, lifetimeAttempts: 0
        };
        updateHUDStats();
    }
    
    // ìƒˆ ë‹‰ë„¤ì„ ì €ì¥
    localStorage.setItem(CURRENT_NICKNAME_KEY, nick);
    nickname = nick;
    
    // ì´ì „ ì €ì¥ ì‚­ì œ (ìƒˆ ê²Œì„ì´ë¯€ë¡œ)
    localStorage.removeItem(SAVE_KEY);
    
    resetGameData();
    startGameCommon();
}

function loadGameAndStart() {
    const saveDataStr = localStorage.getItem(SAVE_KEY);
    if (!saveDataStr) return;

    const data = JSON.parse(saveDataStr);
    
    // ë°ì´í„° ë³µêµ¬
    score = data.score;
    totalCorrect = data.totalCorrect;
    totalWrong = data.totalWrong || 0; // í•˜ìœ„ í˜¸í™˜
    consecutiveCorrect = data.consecutiveCorrect;
    maxCombo = data.maxCombo;
    nickname = data.nickname;
    frameCount = data.frameCount;
    nextGateFrame = data.nextGateFrame;
    currentQuestionObj = data.currentQuestionObj;

    player = new Player(data.player.x, data.player.y, data.player.soldiers);
    enemies = data.enemies.map(e => new Enemy(e.x, e.y, e.hp));
    gates = data.gates.map(g => new Gate(g.x, g.width, g.text, g.isCorrect, g.passed, g.y));
    
    targetX = player.x;
    
    startGameCommon();
}

function startGameCommon() {
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('game-over-screen').classList.add('hidden');
    document.getElementById('hud').classList.remove('hidden');
    gameState = 'PLAYING';
    animate();
}

function resetGameData() {
    player = new Player();
    bullets = []; enemies = []; gates = []; particles = []; floatingTexts = [];
    score = 0; frameCount = 0; nextGateFrame = 100;
    targetX = GAME_WIDTH / 2 - 20;
    totalCorrect = 0; totalWrong = 0; consecutiveCorrect = 0; maxCombo = 0;
    currentQuestionObj = null;
    updateHUD();
}

function endGame() {
    gameState = 'GAMEOVER';
    
    // ì „ì—­ í†µê³„ ì—…ë°ì´íŠ¸ (ì´ìƒì¹˜ ê²€ì‚¬ ì¶”ê°€)
    // ì ìˆ˜ê°€ ë¹„ì •ìƒì ìœ¼ë¡œ ë†’ê±°ë‚˜(ì˜ˆ: 1ì´ˆë‹¹ 1000ì  ì´ìƒ), ì •ë‹µ ìˆ˜ê°€ ì „ì²´ ë¬¸ì œ ìˆ˜ë³´ë‹¤ ë§ì€ ê²½ìš° ë“± ì²´í¬ ê°€ëŠ¥í•˜ë‚˜
    // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ìŒìˆ˜ ì²´í¬ ë° ë…¼ë¦¬ì  ì˜¤ë¥˜ë§Œ ë°©ì–´
    
    if (score < 0) score = 0;
    
    if (score > globalStats.bestScore) globalStats.bestScore = score;
    if (totalCorrect > globalStats.bestCorrect) globalStats.bestCorrect = totalCorrect;
    if (maxCombo > globalStats.bestMaxCombo) globalStats.bestMaxCombo = maxCombo;
    
    // ëˆ„ì  ë°ì´í„° ë¬´ê²°ì„± ì²´í¬ (ê°‘ìê¸° 0ì´ ë˜ê±°ë‚˜ ì¤„ì–´ë“œëŠ” ê²½ìš° ë°©ì§€)
    const newLifetimeCorrect = globalStats.lifetimeCorrect + totalCorrect;
    const newLifetimeAttempts = globalStats.lifetimeAttempts + (totalCorrect + totalWrong);
    
    if (newLifetimeCorrect >= globalStats.lifetimeCorrect) {
        globalStats.lifetimeCorrect = newLifetimeCorrect;
    }
    if (newLifetimeAttempts >= globalStats.lifetimeAttempts) {
        globalStats.lifetimeAttempts = newLifetimeAttempts;
    }
    
    saveGlobalStats(); // í†µê³„ ì €ì¥ (ì•”í˜¸í™”ë¨)
    updateHUDStats(); // HUD ê°±ì‹  (ê²Œì„ì˜¤ë²„ í™”ë©´ ë’¤ë¡œ ë³´ì´ì§€ë§Œ ì—…ë°ì´íŠ¸ í•´ë‘ )
    
    // ê¸€ë¡œë²Œ ë­í‚¹ ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡ (ë¹„ë™ê¸°)
    sendToGlobalRanking();

    saveRecord();
    localStorage.removeItem(SAVE_KEY); // ê²Œì„ ëë‚¬ìœ¼ë¯€ë¡œ ì €ì¥ ì‚­ì œ

    document.getElementById('hud').classList.add('hidden');
    document.getElementById('game-over-screen').classList.remove('hidden');
    document.getElementById('final-msg').innerText = `${nickname}ë‹˜ ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!`;
    document.getElementById('final-score-text').innerText = `ìµœì¢… ì ìˆ˜: ${Math.floor(score)}`;
    document.getElementById('final-stats-text').innerText = `ì •ë‹µ: ${totalCorrect}ê°œ / ìµœëŒ€ ì½¤ë³´: ${maxCombo}`;
}

function returnToMain() {
    document.getElementById('game-over-screen').classList.add('hidden');
    document.getElementById('start-screen').classList.remove('hidden');
    initStartScreen();
}

    // ê¸°ë¡ ë³´ê¸°
    function showRecords() {
        const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
        const tbody = document.querySelector('#records-table tbody');
        tbody.innerHTML = '';
        
        if(records.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        } else {
            records.forEach((rec, idx) => {
                const tr = document.createElement('tr');
                // maxComboê°€ ì—†ëŠ” êµ¬ë²„ì „ ê¸°ë¡ í˜¸í™˜ì„± ì²˜ë¦¬
                const combo = rec.maxCombo !== undefined ? rec.maxCombo : '-';
                tr.innerHTML = `<td>${idx+1}</td><td>${rec.name}</td><td>${rec.score}</td><td>${rec.correct}</td><td>${combo}</td>`;
                tbody.appendChild(tr);
            });
        }
        document.getElementById('records-screen').classList.remove('hidden');
    }
function hideRecords() {
    document.getElementById('records-screen').classList.add('hidden');
}

// ì´ˆê¸°í™” í™•ì¸
function initStartScreen() {
    // ì €ì¥ëœ ë‹‰ë„¤ì„ ë¶ˆëŸ¬ì˜¤ê¸°
    const storedNick = localStorage.getItem(CURRENT_NICKNAME_KEY);
    if (storedNick) {
        document.getElementById('nickname-input').value = storedNick;
    }

    if(checkSavedGame()) {
        document.getElementById('resume-area').classList.remove('hidden');
    } else {
        document.getElementById('resume-area').classList.add('hidden');
    }
}

// ìë™ ì €ì¥ (ì°½ ë‹«ê¸°/ìˆ¨ê¹€ ì‹œ)
document.addEventListener("visibilitychange", () => {
    if (document.hidden && gameState === 'PLAYING') {
        saveGame();
        gameState = 'PAUSED';
    } else if (!document.hidden && gameState === 'PAUSED') {
        // ë³µê·€ ì‹œ ìë™ ì‹¤í–‰ (ì„ íƒì‚¬í•­)
        gameState = 'PLAYING';
        animate();
    }
});

// ì°½ ë‹«ê¸° ì „ ì €ì¥
window.addEventListener('beforeunload', () => {
    if (gameState === 'PLAYING') saveGame();
});

window.addEventListener('resize', () => {
    GAME_WIDTH = window.innerWidth > 600 ? 600 : window.innerWidth;
    GAME_HEIGHT = window.innerHeight;
    canvas.width = GAME_WIDTH; canvas.height = GAME_HEIGHT;
    if(player) player.y = GAME_HEIGHT - 150;
});

// ì´ˆê¸° ì‹¤í–‰
loadGlobalStats(); // í†µê³„ ë¡œë“œ
initStartScreen();

/**
 * 8. ì˜¤ë””ì˜¤ ì‹œìŠ¤í…œ
 */
const bgmAudio = document.getElementById('bgm-audio');
const sfxCorrect = document.getElementById('sfx-correct');
const sfxWrong = document.getElementById('sfx-wrong');
const sfxBomb = document.getElementById('sfx-bomb');
const bgmBtn = document.getElementById('bgm-btn');

let isSoundOn = false; // ì†Œë¦¬ ì „ì²´ ON/OFF ìƒíƒœ

function toggleSound() {
    if (isSoundOn) {
        // ì†Œë¦¬ ë„ê¸°
        bgmAudio.pause();
        isSoundOn = false;
        bgmBtn.innerText = "ğŸµ ì†Œë¦¬: OFF";
        bgmBtn.style.background = "rgba(0, 0, 0, 0.5)";
    } else {
        // ì†Œë¦¬ ì¼œê¸°
        isSoundOn = true;
        bgmAudio.volume = 0.5; // BGM ë³¼ë¥¨ 50%
        
        // ì‚¬ìš©ì ì œìŠ¤ì²˜ í›„ ì¬ìƒ ì‹œë„
        bgmAudio.play().then(() => {
            bgmBtn.innerText = "ğŸµ ì†Œë¦¬: ON";
            bgmBtn.style.background = "rgba(46, 204, 113, 0.7)";
        }).catch(e => {
            console.log("ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:", e);
            isSoundOn = false; // ì¬ìƒ ì‹¤íŒ¨ ì‹œ ìƒíƒœ ë³µêµ¬
            alert("ë¸Œë¼ìš°ì € ì„¤ì •ìœ¼ë¡œ ì¸í•´ ì˜¤ë””ì˜¤ ì¬ìƒì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. í™”ë©´ì„ í´ë¦­ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        });
    }
}

function playSound(type) {
    if (!isSoundOn) return; // ì†Œë¦¬ êº¼ì ¸ìˆìœ¼ë©´ ì¬ìƒ ì•ˆ í•¨

    let audio = null;
    if (type === 'correct') audio = sfxCorrect;
    else if (type === 'wrong') audio = sfxWrong;
    else if (type === 'bomb') audio = sfxBomb;

    if (audio) {
        audio.currentTime = 0; // ì²˜ìŒë¶€í„° ì¬ìƒ
        audio.volume = 0.8; // íš¨ê³¼ìŒì€ ì¢€ ë” í¬ê²Œ
        audio.play().catch(e => console.log("íš¨ê³¼ìŒ ì¬ìƒ ì‹¤íŒ¨", e));
    }
}

/**
 * 7. ê¸€ë¡œë²Œ ë­í‚¹ ì‹œìŠ¤í…œ (Google Sheets & Apps Script)
 */
function sendToGlobalRanking() {
    if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes("ì—¬ê¸°ì—")) return;

    const payload = {
        action: "update",
        nickname: nickname,
        bestScore: globalStats.bestScore,
        bestCombo: globalStats.bestMaxCombo,
        bestCorrect: globalStats.bestCorrect,
        lifetimeCorrect: globalStats.lifetimeCorrect,
        lifetimeAttempts: globalStats.lifetimeAttempts
    };

    // [ìˆ˜ì •] GET ë°©ì‹ìœ¼ë¡œ ë³€ê²½ (CORS ë¬¸ì œ ìµœì†Œí™” ë° ì „ì†¡ ë³´ì¥)
    // ë°ì´í„°ë¥¼ ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡í•©ë‹ˆë‹¤.
    const queryString = new URLSearchParams(payload).toString();
    
    fetch(GOOGLE_SCRIPT_URL + "?" + queryString)
        .then(res => res.json())
        .then(data => {
            console.log("ë­í‚¹ ì „ì†¡ ì„±ê³µ:", data);
        })
        .catch(err => {
            // GET ë°©ì‹ì€ ì‹¤íŒ¨ í™•ë¥ ì´ ë‚®ì§€ë§Œ, í˜¹ì‹œ ì‹¤íŒ¨í•˜ë”ë¼ë„ ê²Œì„ ì§„í–‰ì—” ì˜í–¥ ì—†ë„ë¡ ê²½ê³ ë§Œ í‘œì‹œ
            console.warn("ë­í‚¹ ì „ì†¡ ì‹¤íŒ¨:", err);
        });
}

function showGlobalRankings() {
    document.getElementById('ranking-screen').classList.remove('hidden');
    loadRankings('bestScore'); // ê¸°ë³¸ê°’: ì ìˆ˜ ë­í‚¹
}

function loadRankings(sortBy) {
    const listDiv = document.getElementById('ranking-list');
    const myRankSection = document.getElementById('my-rank-section');
    const rankInfo = document.getElementById('rank-info');
    
    // íƒ­ í™œì„±í™” ì²˜ë¦¬
    document.querySelectorAll('.rank-tab').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-${sortBy}`).classList.add('active');
    
    // ì•ˆë‚´ ë¬¸êµ¬ ì—…ë°ì´íŠ¸
    if (sortBy === 'accuracy') {
        rankInfo.innerHTML = "âš ï¸ ì •ë‹µë¥  ë­í‚¹ì€ 30ë¬¸ì œ ì´ìƒ í‘¼ ì‚¬ìš©ìë§Œ ì§‘ê³„ë©ë‹ˆë‹¤.<br>(ìƒìœ„ 100ìœ„ í‘œì‹œ)";
        rankInfo.style.color = "#e74c3c";
    } else {
        rankInfo.innerHTML = "ìƒìœ„ 100ìœ„ê¹Œì§€ í‘œì‹œë©ë‹ˆë‹¤.";
        rankInfo.style.color = "#bdc3c7";
    }

    listDiv.innerHTML = '<p class="loading-text">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
    myRankSection.style.display = 'none';

    if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes("ì—¬ê¸°ì—")) {
        listDiv.innerHTML = '<p class="loading-text">ë­í‚¹ ì„œë²„ URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
        return;
    }

    // ë‚´ ë‹‰ë„¤ì„ë„ ê°™ì´ ë³´ë‚´ì„œ ìˆœìœ„ë¥¼ í™•ì¸
    fetch(`${GOOGLE_SCRIPT_URL}?action=getRankings&sortBy=${sortBy}&myNickname=${encodeURIComponent(nickname)}`)
        .then(res => res.json())
        .then(response => {
            const data = response.top100;
            const myRankData = response.myRank;

            if (!data || data.length === 0) {
                listDiv.innerHTML = '<p class="loading-text">ë“±ë¡ëœ ë­í‚¹ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // í…Œì´ë¸” í—¤ë” ê²°ì •
            let valueHeader = "ì ìˆ˜";
            if (sortBy === 'bestCombo') valueHeader = "ì½¤ë³´";
            else if (sortBy === 'lifetimeCorrect') valueHeader = "ëˆ„ì  ì •ë‹µ";
            else if (sortBy === 'accuracy') valueHeader = "ì •ë‹µë¥ ";

            let html = `
                <table class="rank-table">
                    <thead>
                        <tr>
                            <th style="width: 15%">ìˆœìœ„</th>
                            <th style="width: 50%">ì´ë¦„</th>
                            <th style="width: 35%">${valueHeader}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let isMeInTop100 = false;

            data.forEach((item, index) => {
                let value = item.bestScore;
                if (sortBy === 'bestCombo') value = item.bestCombo;
                else if (sortBy === 'lifetimeCorrect') value = item.lifetimeCorrect;
                else if (sortBy === 'accuracy') value = item.accuracy.toFixed(1) + '%';

                const isMe = item.nickname === nickname;
                if (isMe) isMeInTop100 = true;

                html += `
                    <tr class="${isMe ? 'my-rank-row' : ''}">
                        <td>${index + 1}</td>
                        <td>${item.nickname}</td>
                        <td>${value}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            listDiv.innerHTML = html;

            // ë‚´ ìˆœìœ„ê°€ 100ìœ„ ë°–ì´ê±°ë‚˜ ë°ì´í„°ì— ì—†ì§€ë§Œ, ë³„ë„ë¡œ ë°›ì€ ê²½ìš° í‘œì‹œ
            if (!isMeInTop100 && myRankData) {
                let myValue = myRankData.bestScore;
                if (sortBy === 'bestCombo') myValue = myRankData.bestCombo;
                else if (sortBy === 'lifetimeCorrect') myValue = myRankData.lifetimeCorrect;
                else if (sortBy === 'accuracy') myValue = myRankData.accuracy.toFixed(1) + '%';

                const myRankHtml = `
                    <tr class="my-rank-row">
                        <td style="width: 15%">${myRankData.rank}</td>
                        <td style="width: 50%">${myRankData.nickname}</td>
                        <td style="width: 35%">${myValue}</td>
                    </tr>
                `;
                document.getElementById('my-rank-body').innerHTML = myRankHtml;
                myRankSection.style.display = 'block';
            } else if (!isMeInTop100 && sortBy === 'accuracy' && globalStats.lifetimeAttempts < 30) {
                 // ì •ë‹µë¥  ë­í‚¹ì¸ë° ì¡°ê±´ ë¯¸ë‹¬ì¸ ê²½ìš°
                 document.getElementById('my-rank-body').innerHTML = `
                    <tr><td colspan="3" style="color: #e74c3c;">30ë¬¸ì œ ì´ìƒ í’€ì–´ì•¼ ë­í‚¹ì— ì§„ì…í•©ë‹ˆë‹¤. (í˜„ì¬: ${globalStats.lifetimeAttempts})</td></tr>
                 `;
                 myRankSection.style.display = 'block';
            }

        })
        .catch(err => {
            console.error(err);
            listDiv.innerHTML = `
                <div style="padding: 20px; color: #e74c3c;">
                    <p>ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>
                </div>
            `;
        });
}

function hideGlobalRankings() {
    document.getElementById('ranking-screen').classList.add('hidden');
}
</script>
</body>
</html>